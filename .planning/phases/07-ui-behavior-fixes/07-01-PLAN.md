---
phase: 07-ui-behavior-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/store/howAreYouSlice.ts
  - frontend/src/store/dailyNoteSlice.ts
autonomous: true

must_haves:
  truths:
    - "User closes check-in modal and it stays closed until next interval"
    - "User marks task as Later (tomorrow) and task immediately moves to scheduled section"
    - "User marks task as done and task immediately shows as completed"
  artifacts:
    - path: "frontend/src/store/howAreYouSlice.ts"
      provides: "Modal close with timestamp update"
      contains: "storeLastModal"
    - path: "frontend/src/store/dailyNoteSlice.ts"
      provides: "Cross-slice task update listener"
      contains: "howAreYou/taskAction/fulfilled"
  key_links:
    - from: "howAreYouSlice closeModal"
      to: "localStorage lastModalAt"
      via: "storeLastModal call"
      pattern: "storeLastModal\\(now\\)"
    - from: "dailyNoteSlice extraReducers"
      to: "performTaskAction.fulfilled"
      via: "addMatcher or addCase"
      pattern: "howAreYou/taskAction/fulfilled"
---

<objective>
Fix UI behavior bugs: check-in modal dismiss respects user intent, and task category changes from check-in reflect immediately in main task list.

Purpose: Both bugs cause user frustration - modal reopening feels broken, stale task lists feel unresponsive.
Output: Two targeted Redux state fixes that make UI respond correctly to user actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ui-behavior-fixes/07-RESEARCH.md

Key files:
@frontend/src/store/howAreYouSlice.ts
@frontend/src/store/dailyNoteSlice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix check-in modal dismiss (CHKN-01)</name>
  <files>frontend/src/store/howAreYouSlice.ts</files>
  <action>
Update the `closeModal` reducer (line 277-279) to also update `lastModalAt` timestamp when the modal is closed.

Current code:
```typescript
closeModal: (state) => {
  state.isOpen = false;
},
```

Update to:
```typescript
closeModal: (state) => {
  state.isOpen = false;
  // Update lastModalAt on close to prevent immediate reopen
  // This ensures the next interval counts from dismiss time, not open time
  const now = new Date().toISOString();
  state.lastModalAt = now;
  storeLastModal(now);
},
```

This ensures that when user manually dismisses the modal, the timestamp is updated so the interval check in `useAutoModal` won't reopen it prematurely.

Note: `storeLastModal` helper already exists at line 33-42, no need to create it.
  </action>
  <verify>
1. `npm run lint` passes in frontend directory
2. `npm run build` passes in frontend directory
  </verify>
  <done>
closeModal reducer updates lastModalAt and persists to localStorage, preventing modal from reopening until next scheduled interval.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix immediate task list updates (UIST-01)</name>
  <files>frontend/src/store/dailyNoteSlice.ts</files>
  <action>
Add an extraReducer in `dailyNoteSlice.ts` that listens for `performTaskAction.fulfilled` from howAreYouSlice and updates the task in the main task list.

At the top of the file, add import (after existing imports around line 4):
```typescript
import { performTaskAction } from './howAreYouSlice';
```

Then add the following case at the end of the `extraReducers` builder chain (before the closing of the builder, around line 551), after the assignTaskTags handler:

```typescript
      // Cross-slice: Update task when check-in actions are performed
      .addCase(performTaskAction.fulfilled, (state, action) => {
        if (!state.dailyNote) return;

        const { action: taskAction, result } = action.payload;
        const updatedTask = result.task;
        const categories = ['today', 'scheduled', 'someday', 'overdue'] as const;

        // Find the task in any category
        for (const category of categories) {
          const taskList = state.dailyNote.tasks[category];
          if (!taskList) continue;

          const index = taskList.findIndex((t) => t.id === updatedTask.id);
          if (index !== -1) {
            if (taskAction === 'done') {
              // Mark as completed in place
              taskList[index] = {
                ...taskList[index],
                isCompleted: true,
                completedAt: updatedTask.completedAt,
              };
            } else if (taskAction === 'tomorrow') {
              // Remove from current category, add to scheduled
              const [task] = taskList.splice(index, 1);
              state.dailyNote.tasks.scheduled.push({
                ...task,
                dueDate: updatedTask.dueDate,
              });
            } else if (taskAction === 'today') {
              // Update dueDate in place (task stays in current category for now)
              taskList[index] = {
                ...taskList[index],
                dueDate: updatedTask.dueDate,
              };
            } else if (taskAction === 'drop') {
              // Remove from list entirely
              taskList.splice(index, 1);
            }
            break;
          }
        }
      });
```

Why this approach:
- Uses existing Redux Toolkit pattern (extraReducers/addCase)
- No circular import issue - importing action from howAreYouSlice is safe
- Updates happen immediately in the same dispatch cycle
- Handles all 4 check-in actions: done, tomorrow, today, drop
  </action>
  <verify>
1. `npm run lint` passes in frontend directory
2. `npm run build` passes in frontend directory (TypeScript compiles without errors)
  </verify>
  <done>
Task list updates immediately when user performs check-in actions - done marks complete, tomorrow moves to scheduled, today updates date, drop removes task.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   cd frontend && npm run build
   ```
   Should complete without TypeScript errors.

2. Lint verification:
   ```bash
   cd frontend && npm run lint
   ```
   Should pass without errors.

3. Manual testing (for user verification):
   - Open app, trigger check-in modal
   - Close modal without completing check-in
   - Wait 10-30 seconds - modal should NOT reopen until next interval
   - Open check-in again, mark a task as "Tomorrow"
   - Close check-in, verify task moved to "Later" section without page refresh
</verification>

<success_criteria>
- [ ] CHKN-01: closeModal sets lastModalAt timestamp and persists to localStorage
- [ ] UIST-01: performTaskAction.fulfilled triggers immediate update in dailyNoteSlice
- [ ] TypeScript compilation passes
- [ ] Lint passes
- [ ] No new warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/07-ui-behavior-fixes/07-01-SUMMARY.md`
</output>
