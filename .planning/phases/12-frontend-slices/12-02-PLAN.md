---
phase: 12-frontend-slices
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/store/planningFlowSlice.ts
  - frontend/src/store/rebuildFlowSlice.ts
autonomous: true

must_haves:
  truths:
    - "Planning flow state managed in dedicated slice"
    - "Rebuild flow state managed in dedicated slice"
    - "Each slice under 200 lines"
  artifacts:
    - path: "frontend/src/store/planningFlowSlice.ts"
      provides: "Planning flow slice with thunks"
      exports: ["fetchPlanningTasks", "savePlanningTask", "generateSchedule", "acceptSchedule"]
      max_lines: 200
    - path: "frontend/src/store/rebuildFlowSlice.ts"
      provides: "Rebuild flow slice with thunks"
      exports: ["fetchRebuildData", "generateRebuild", "acceptRebuild"]
      max_lines: 180
  key_links:
    - from: "frontend/src/store/planningFlowSlice.ts"
      to: "frontend/src/store/howAreYouSlice.ts"
      via: "imports selectMode, closeModal for extraReducers"
      pattern: "import.*from.*howAreYouSlice"
    - from: "frontend/src/store/rebuildFlowSlice.ts"
      to: "frontend/src/store/howAreYouSlice.ts"
      via: "imports selectMode, closeModal for extraReducers"
      pattern: "import.*from.*howAreYouSlice"
---

<objective>
Create planningFlowSlice and rebuildFlowSlice from monolithic howAreYouSlice.

Purpose: Complete the flow extraction by creating dedicated slices for Planning and Rebuild flows, maintaining the same state shape for backward compatibility.

Output:
- planningFlowSlice.ts (~180 lines) with Planning state, thunks, and reducers
- rebuildFlowSlice.ts (~160 lines) with Rebuild state, thunks, and reducers
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-slices/12-RESEARCH.md

@frontend/src/store/howAreYouSlice.ts (original, before Plan 01 modifications)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create planningFlowSlice with state and thunks</name>
  <files>frontend/src/store/planningFlowSlice.ts</files>
  <action>
Create new file `planningFlowSlice.ts` extracting Planning functionality from howAreYouSlice:

1. Import dependencies:
   - createSlice, createAsyncThunk, PayloadAction from @reduxjs/toolkit
   - api from @/lib/api
   - selectMode, closeModal from ./howAreYouSlice (for extraReducers)
   - Types from @/types: PlanningTask, PlanningEvent, PlanningTaskData, GeneratedSchedule, PlanningStats, ScheduleSuggestion

2. Define local types:
   - PlanningStep = 'estimation' | 'fixed_time' | 'combine'
   - PlanningPhase = 'conflicts' | 'planning' | 'summary'

3. Define PlanningFlowState interface (copy from howAreYouSlice.PlanningState):
   - tasks: PlanningTask[]
   - conflictingTasks: PlanningTask[]
   - events: PlanningEvent[]
   - currentPhase: PlanningPhase
   - currentIndex: number
   - currentStep: PlanningStep
   - taskPlanData: Record<number, PlanningTaskData>
   - resolvedConflicts: Record<number, 'keep' | 'reschedule'>
   - generatedSchedule: GeneratedSchedule | null
   - stats: PlanningStats
   - isLoading: boolean
   - isGenerating: boolean
   - error: string | null

4. Create thunks with NEW action type prefixes:
   - fetchPlanningTasks: 'planningFlow/fetchTasks'
   - savePlanningTask: 'planningFlow/saveTask'
   - generateSchedule: 'planningFlow/generateSchedule'
   - acceptSchedule: 'planningFlow/acceptSchedule'

   Note for acceptSchedule: It needs to access its own state. Update the getState cast to use planningFlow key:
   ```typescript
   const state = getState() as { planningFlow: PlanningFlowState };
   const schedule = modifiedSchedule || state.planningFlow.generatedSchedule?.schedule || [];
   ```

5. Create slice with reducers (copy logic from howAreYouSlice):
   - nextStep (was nextPlanningStep)
   - previousStep (was previousPlanningStep)
   - nextTask (was nextPlanningTask)
   - skipTask (was skipPlanningTask)
   - setEstimation
   - setFixedTime
   - setCombineEvents
   - setNeedsFullFocus
   - markTaskPlanned
   - resolveConflict
   - nextConflict
   - finishConflictPhase
   - setPhase (was setPlanningPhase)
   - clearError

6. Add extraReducers:
   - selectMode: Reset state when mode === 'planning'
   - closeModal: state.isOpen = false equivalent (just return to allow modal close side effect)
   - Handle all thunk pending/fulfilled/rejected cases (copy from howAreYouSlice)

7. Export thunks, actions, and default reducer
  </action>
  <verify>File created with no TypeScript errors: `cd /home/kamil/Code/dumpday/frontend && npx tsc --noEmit 2>&1 | grep -E "planningFlowSlice|error" | head -20`</verify>
  <done>planningFlowSlice.ts exists with all Planning state management and thunks</done>
</task>

<task type="auto">
  <name>Task 2: Create rebuildFlowSlice with state and thunks</name>
  <files>frontend/src/store/rebuildFlowSlice.ts</files>
  <action>
Create new file `rebuildFlowSlice.ts` extracting Rebuild functionality from howAreYouSlice:

1. Import dependencies:
   - createSlice, createAsyncThunk, PayloadAction from @reduxjs/toolkit
   - api from @/lib/api
   - selectMode, closeModal from ./howAreYouSlice (for extraReducers)
   - Types from @/types: Task, PlanningEvent, RebuildParsedItems, GeneratedSchedule, ScheduleSuggestion

2. Define local types:
   - RebuildStep = 'whats_happening' | 'anything_else' | 'work_until' | 'preview'

3. Export RebuildStep type (used by components)

4. Define RebuildFlowState interface (copy from howAreYouSlice.RebuildState):
   - step: RebuildStep
   - tasks: Task[]
   - events: PlanningEvent[]
   - selectedTaskIds: number[]
   - selectedEventIds: number[]
   - additionalInput: string
   - workUntilTime: string
   - parsedItems: RebuildParsedItems
   - generatedSchedule: GeneratedSchedule | null
   - isLoading: boolean
   - isGenerating: boolean
   - error: string | null

5. Create thunks with NEW action type prefixes:
   - fetchRebuildData: 'rebuildFlow/fetchData'
   - generateRebuild: 'rebuildFlow/generate'
   - acceptRebuild: 'rebuildFlow/accept'

   Note for generateRebuild and acceptRebuild: Update getState cast to use rebuildFlow key:
   ```typescript
   const state = getState() as { rebuildFlow: RebuildFlowState };
   ```

6. Create slice with reducers (copy logic from howAreYouSlice):
   - setStep (was setRebuildStep)
   - toggleTaskSelection
   - toggleEventSelection
   - setAdditionalInput
   - setWorkUntilTime
   - clearError

7. Add extraReducers:
   - selectMode: Reset state when mode === 'rebuild'
   - closeModal: Allow modal close side effect
   - Handle all thunk pending/fulfilled/rejected cases (copy from howAreYouSlice)
   - Note: On acceptRebuild.fulfilled, set appropriate state instead of state.isOpen = false

8. Export RebuildStep type, thunks, actions, and default reducer
  </action>
  <verify>File created with no TypeScript errors: `cd /home/kamil/Code/dumpday/frontend && npx tsc --noEmit 2>&1 | grep -E "rebuildFlowSlice|error" | head -20`</verify>
  <done>rebuildFlowSlice.ts exists with all Rebuild state management, thunks, and RebuildStep type export</done>
</task>

</tasks>

<verification>
1. Both files compile without TypeScript errors
2. planningFlowSlice.ts under 200 lines
3. rebuildFlowSlice.ts under 180 lines
4. All thunks properly defined with new action type prefixes
5. No circular imports with howAreYouSlice
</verification>

<success_criteria>
- planningFlowSlice.ts: Complete Planning state management (~180 lines)
- rebuildFlowSlice.ts: Complete Rebuild state management (~160 lines)
- Both slices import selectMode/closeModal from coordinator for extraReducers
- Both files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-slices/12-02-SUMMARY.md`
</output>
