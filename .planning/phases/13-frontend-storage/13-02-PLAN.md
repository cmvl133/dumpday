---
phase: 13-frontend-storage
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/store/tagSlice.ts
  - frontend/src/store/howAreYouSlice.ts
  - frontend/src/store/checkInFlowSlice.ts
autonomous: true

must_haves:
  truths:
    - "tagSlice uses centralized storage utilities"
    - "howAreYouSlice uses centralized storage utilities"
    - "checkInFlowSlice uses centralized storage utilities"
    - "No direct localStorage calls in any migrated slice"
    - "Existing tag filter and last modal data preserved after migration"
  artifacts:
    - path: "frontend/src/store/tagSlice.ts"
      provides: "Tag filtering with centralized storage"
      contains: "STORAGE_KEYS.TAG_FILTER"
    - path: "frontend/src/store/howAreYouSlice.ts"
      provides: "Modal state with centralized storage"
      contains: "STORAGE_KEYS.LAST_MODAL"
    - path: "frontend/src/store/checkInFlowSlice.ts"
      provides: "Check-in flow with centralized storage"
      contains: "STORAGE_KEYS.LAST_MODAL"
  key_links:
    - from: "frontend/src/store/tagSlice.ts"
      to: "frontend/src/lib/storage.ts"
      via: "imports getStorageItem, setStorageItem, STORAGE_KEYS"
      pattern: "import.*STORAGE_KEYS.*from.*storage"
    - from: "frontend/src/store/howAreYouSlice.ts"
      to: "frontend/src/lib/storage.ts"
      via: "imports getStorageItem, setStorageItem, removeStorageItem, STORAGE_KEYS"
      pattern: "import.*STORAGE_KEYS.*from.*storage"
---

<objective>
Migrate Redux slices to use centralized storage utilities.

Purpose: Remove duplicate localStorage helper functions from slices. All three slices (tagSlice, howAreYouSlice, checkInFlowSlice) currently have their own get/set functions with identical try/catch patterns.

Output: Slices using shared storage utilities from lib/storage.ts with no direct localStorage calls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-frontend-storage/13-01-SUMMARY.md
@frontend/src/store/tagSlice.ts
@frontend/src/store/howAreYouSlice.ts
@frontend/src/store/checkInFlowSlice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate tagSlice.ts</name>
  <files>frontend/src/store/tagSlice.ts</files>
  <action>
Refactor `frontend/src/store/tagSlice.ts`:

1. Add import at top:
```typescript
import { getStorageItem, setStorageItem, STORAGE_KEYS } from '@/lib/storage';
```

2. Replace `loadFilterState` function:
```typescript
// OLD:
const loadFilterState = (): { activeFilters: number[]; filterMode: TagFilterMode } => {
  try {
    const saved = localStorage.getItem('tagFilter');
    // ...
  } catch { /* ... */ }
};

// NEW:
const loadFilterState = () => getStorageItem(
  STORAGE_KEYS.TAG_FILTER,
  { activeFilters: [] as number[], filterMode: 'or' as const }
);
```

3. Replace `saveFilterState` function:
```typescript
// OLD:
const saveFilterState = (activeFilters: number[], filterMode: TagFilterMode) => {
  try {
    localStorage.setItem('tagFilter', JSON.stringify({ activeFilters, filterMode }));
  } catch { /* ... */ }
};

// NEW:
const saveFilterState = (activeFilters: number[], filterMode: TagFilterMode) =>
  setStorageItem(STORAGE_KEYS.TAG_FILTER, { activeFilters, filterMode });
```

4. Keep all existing slice logic unchanged - only the storage access functions change.

Key decisions:
- Keep function names (loadFilterState, saveFilterState) to minimize changes in reducers
- Use type assertion for filterMode default ('or' as const) to match 'and' | 'or' type
  </action>
  <verify>
TypeScript compilation: `cd frontend && npx tsc --noEmit`
Grep for direct localStorage calls: `grep -n "localStorage" frontend/src/store/tagSlice.ts` (should return nothing)
  </verify>
  <done>
- tagSlice imports from @/lib/storage
- No direct localStorage.getItem or localStorage.setItem calls
- loadFilterState uses getStorageItem with STORAGE_KEYS.TAG_FILTER
- saveFilterState uses setStorageItem with STORAGE_KEYS.TAG_FILTER
- All reducer logic unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate howAreYouSlice.ts and checkInFlowSlice.ts</name>
  <files>frontend/src/store/howAreYouSlice.ts, frontend/src/store/checkInFlowSlice.ts</files>
  <action>
Both slices use `dopaminder_last_modal` key with identical helper functions. Migrate both together.

**howAreYouSlice.ts:**

1. Add import at top:
```typescript
import { getStorageItem, setStorageItem, removeStorageItem, STORAGE_KEYS } from '@/lib/storage';
```

2. Remove local helper functions:
```typescript
// DELETE these:
const LAST_MODAL_KEY = 'dopaminder_last_modal';
function getStoredLastModal(): string | null { ... }
function storeLastModal(value: string | null): void { ... }
```

3. Replace usages:
```typescript
// In initialState:
lastModalAt: getStorageItem(STORAGE_KEYS.LAST_MODAL, null),

// In reducers/extraReducers where storeLastModal(value) is called:
setStorageItem(STORAGE_KEYS.LAST_MODAL, value)

// Where storeLastModal(null) or remove is called:
removeStorageItem(STORAGE_KEYS.LAST_MODAL)
```

Note: getStorageItem with null default handles the date validation that was in getStoredLastModal - we'll add that validation inline if needed OR accept that invalid dates become null on parse failure.

**checkInFlowSlice.ts:**

1. Add import at top:
```typescript
import { getStorageItem, setStorageItem, removeStorageItem, STORAGE_KEYS } from '@/lib/storage';
```

2. Remove local helper functions:
```typescript
// DELETE these:
const LAST_MODAL_KEY = 'dopaminder_last_modal';
function getStoredLastModal(): string | null { ... }
function storeLastModal(value: string | null): void { ... }
```

3. Replace usages (same pattern as howAreYouSlice):
- In initialState: `getStorageItem(STORAGE_KEYS.LAST_MODAL, null)`
- On store: `setStorageItem(STORAGE_KEYS.LAST_MODAL, value)`
- On remove: `removeStorageItem(STORAGE_KEYS.LAST_MODAL)`

Key decisions:
- Both slices read/write the same key - this is intentional (they sync the same value)
- Date validation (checking if stored string is valid date) can be removed - JSON.parse will either succeed or fall back to null
- The slices now share the storage key constant instead of duplicating the string
  </action>
  <verify>
TypeScript compilation: `cd frontend && npx tsc --noEmit`
Grep for direct localStorage calls:
- `grep -n "localStorage" frontend/src/store/howAreYouSlice.ts` (should return nothing)
- `grep -n "localStorage" frontend/src/store/checkInFlowSlice.ts` (should return nothing)
Grep for old key constant:
- `grep -n "LAST_MODAL_KEY" frontend/src/store/*.ts` (should return nothing)
  </verify>
  <done>
- howAreYouSlice imports from @/lib/storage
- checkInFlowSlice imports from @/lib/storage
- No direct localStorage calls in either slice
- No LAST_MODAL_KEY constant in either slice
- Both use STORAGE_KEYS.LAST_MODAL from centralized storage
- All reducer/extraReducer logic unchanged
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compilation passes: `cd frontend && npx tsc --noEmit`
2. No direct localStorage calls in migrated slices:
   ```bash
   grep -rn "localStorage\." frontend/src/store/tagSlice.ts frontend/src/store/howAreYouSlice.ts frontend/src/store/checkInFlowSlice.ts
   ```
   Should return empty
3. All slices import from @/lib/storage
4. Frontend runs without errors: `cd frontend && npm run dev` (manual check)
5. Tag filters persist across page refresh (manual check)
6. Last modal time persists across page refresh (manual check)
</verification>

<success_criteria>
- [ ] tagSlice.ts uses getStorageItem/setStorageItem from @/lib/storage
- [ ] howAreYouSlice.ts uses getStorageItem/setStorageItem/removeStorageItem from @/lib/storage
- [ ] checkInFlowSlice.ts uses getStorageItem/setStorageItem/removeStorageItem from @/lib/storage
- [ ] No direct localStorage calls in any migrated slice
- [ ] TypeScript compilation passes
- [ ] Existing stored data (tag filters, last modal) preserved after migration
</success_criteria>

<output>
After completion, create `.planning/phases/13-frontend-storage/13-02-SUMMARY.md`
</output>
