---
phase: 08-ai-planning-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Task splitting behavior is documented and understood"
    - "Scheduled tasks (dueDate=today, no fixedTime) appear in planning view"
    - "Any identified issues are either fixed or documented for follow-up"
  artifacts: []
  key_links: []
---

<objective>
Investigate task splitting (PLAN-02) and verify scheduled tasks in planning (PLAN-03).

Purpose: PLAN-02 requires investigation to understand what's broken. PLAN-03 may already work correctly - needs verification.
Output: Investigation findings, confirmed behavior, any necessary fixes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-planning-fixes/08-RESEARCH.md

# Key source files for investigation
@backend/src/Service/TaskSplitService.php
@backend/src/Controller/TaskSplitController.php
@backend/src/Repository/TaskRepository.php
@frontend/src/components/planning/TaskSplitStep.tsx
@frontend/src/components/planning/SplitPreview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify PLAN-03 - Scheduled tasks appear in planning</name>
  <files></files>
  <action>
Verify that tasks with `dueDate = today` and `fixedTime = null` appear in the planning view.

**Research findings suggest this already works:**
The query `findUnplannedTasksForToday()` includes:
```sql
WHERE (t.dueDate = :today OR (t.category = 'today' AND dn.date = :today))
  AND t.fixedTime IS NULL
```

The `t.dueDate = :today` clause catches scheduled tasks regardless of category.

**Verification steps:**

1. Check the TaskRepository query logic:
   - Read `backend/src/Repository/TaskRepository.php` findUnplannedTasksForToday()
   - Confirm query includes dueDate = today condition

2. Check API response:
   - Read `backend/src/Controller/PlanningController.php`
   - Confirm it returns tasks from findUnplannedTasksForToday()

3. Test with live data (if available):
   - Look for any task with category='scheduled' and dueDate=today
   - Verify it appears in planning mode

**If issue found:** Document the specific problem and create a fix task.
**If works correctly:** Document the behavior for SUMMARY.
  </action>
  <verify>
    - Query logic in TaskRepository includes `t.dueDate = :today` condition
    - No additional filters that would exclude scheduled tasks
  </verify>
  <done>
    - PLAN-03 behavior verified (works or issue documented)
    - If working: documented in SUMMARY that query already handles scheduled tasks
    - If broken: specific issue identified for fix
  </done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>What is the actual issue with task splitting (PLAN-02)?</decision>
  <context>
The requirement says "AI task splitting behavior works as expected (investigate and fix)" but doesn't specify what's broken.

**What exists:**
- Backend: TaskSplitService with proposeSplit(), splitTask(), mergeSubtasks()
- Frontend: TaskSplitStep, SplitPreview components
- Flow: Task doesn't fit in schedule -> show split options -> user chooses -> execute split

**Current behavior (from code analysis):**
1. During schedule generation, tasks with `suggestedTime === null` and `estimatedMinutes > 30` are flagged
2. Frontend fetches split proposals and available slots
3. User can: Split, Move to Tomorrow, or Handle Manually
4. Splitting creates subtasks with isPart=true, partNumber=1,2,3...
5. Parent task gets fixedTime=null after split

**Potential issues (guesses):**
- Split happens AFTER AI scheduling, not integrated into it
- Subtask naming unclear ("Task (part 1)" in Polish)
- UX flow confusing for users
- Split parts don't respect events properly

**Need user input to understand the actual bug.**
  </context>
  <options>
    <option id="no-issue">
      <name>No issue - behavior works as designed</name>
      <pros>No changes needed, close PLAN-02 as verified</pros>
      <cons>May have misunderstood the requirement</cons>
    </option>
    <option id="ux-issue">
      <name>UX issue - flow is confusing</name>
      <pros>Can improve UX/messaging without changing logic</pros>
      <cons>May need follow-up phase for UX changes</cons>
    </option>
    <option id="logic-issue">
      <name>Logic issue - splitting doesn't work correctly</name>
      <pros>Can fix specific bug once identified</pros>
      <cons>Need specific reproduction steps</cons>
    </option>
    <option id="defer">
      <name>Defer - need more information</name>
      <pros>Don't fix what we don't understand</pros>
      <cons>PLAN-02 remains open</cons>
    </option>
  </options>
  <resume-signal>
Please describe what's wrong with task splitting:
- What did you expect to happen?
- What actually happened?
- Can you give a specific example?

Select: no-issue, ux-issue, logic-issue, or defer
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document findings and apply any fixes</name>
  <files></files>
  <action>
Based on checkpoint decision:

**If no-issue:**
- Document that task splitting works as designed
- Close PLAN-02 as verified

**If ux-issue:**
- Document the specific UX improvements needed
- If small (text changes, clarifications): implement in this plan
- If large (flow changes, new components): create follow-up task for next phase

**If logic-issue:**
- Implement the specific fix based on user feedback
- Test the fix manually

**If defer:**
- Document current behavior in SUMMARY
- Keep PLAN-02 open in REQUIREMENTS.md for future clarification

Update SUMMARY with:
- PLAN-02 status and findings
- PLAN-03 verification results
- Any changes made
  </action>
  <verify>
    - SUMMARY documents both PLAN-02 and PLAN-03 outcomes
    - If fixes applied: verify manually that the fix works
  </verify>
  <done>
    - PLAN-02 investigated and resolved (fixed, verified, or deferred with documentation)
    - PLAN-03 verified (working or fixed)
    - SUMMARY created with findings
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. PLAN-03: Confirm scheduled tasks query works:
   ```bash
   grep -A 5 "findUnplannedTasksForToday" backend/src/Repository/TaskRepository.php
   ```

2. PLAN-02: Document findings based on checkpoint decision.

3. Manual verification if any changes were made.
</verification>

<success_criteria>
- PLAN-03 verified (scheduled tasks appear in planning, or issue identified and fixed)
- PLAN-02 investigated (issue understood, fixed, or deferred with clear rationale)
- All findings documented in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-planning-fixes/08-02-SUMMARY.md`
</output>
