---
phase: 08-ai-planning-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/Entity/Event.php
  - backend/migrations/VersionXXXXXXXX.php
  - backend/src/Service/PlanningScheduleGenerator.php
  - backend/templates/prompts/schedule_optimization_en.twig
  - backend/templates/prompts/schedule_optimization_pl.twig
  - backend/templates/prompts/schedule_rebuild_en.twig
  - backend/templates/prompts/schedule_rebuild_pl.twig
  - frontend/src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Events have allowOverlap property (default false)"
    - "AI knows which events allow task overlap"
    - "AI does NOT schedule tasks during events with allowOverlap=false"
    - "AI CAN schedule tasks during events with allowOverlap=true (when task has canCombineWithEvents)"
  artifacts:
    - path: "backend/src/Entity/Event.php"
      provides: "allowOverlap boolean property with getter/setter"
      contains: "private ?bool $allowOverlap"
    - path: "backend/migrations/VersionXXXXXXXX.php"
      provides: "Database migration for allow_overlap column"
      contains: "allow_overlap"
    - path: "backend/src/Service/PlanningScheduleGenerator.php"
      provides: "allowOverlap in event data passed to AI"
      contains: "allowOverlap"
    - path: "backend/templates/prompts/schedule_optimization_en.twig"
      provides: "Overlap constraint rules in English prompt"
      contains: "allowOverlap"
    - path: "frontend/src/types/index.ts"
      provides: "Event interface with allowOverlap property"
      contains: "allowOverlap"
  key_links:
    - from: "backend/src/Entity/Event.php"
      to: "database (events table)"
      via: "Doctrine ORM mapping"
      pattern: "ORM\\\\Column.*allowOverlap"
    - from: "backend/src/Service/PlanningScheduleGenerator.php"
      to: "backend/templates/prompts/*.twig"
      via: "Twig render with eventData"
      pattern: "allowOverlap.*isAllowOverlap"
---

<objective>
Add allowOverlap property to Event entity and enforce in AI scheduling prompts.

Purpose: PLAN-01 - AI should not schedule tasks during events unless the event explicitly allows overlap.
Output: Event entity with allowOverlap property, updated AI prompts with constraint enforcement.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-planning-fixes/08-RESEARCH.md

# Key source files
@backend/src/Entity/Event.php
@backend/src/Service/PlanningScheduleGenerator.php
@backend/templates/prompts/schedule_optimization_en.twig
@frontend/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add allowOverlap to Event entity and create migration</name>
  <files>
    backend/src/Entity/Event.php
    backend/migrations/VersionXXXXXXXX.php (generate via doctrine:migrations:diff)
  </files>
  <action>
1. Add `allowOverlap` boolean property to Event entity:
   - Property: `private ?bool $allowOverlap = false;`
   - Doctrine annotation: `#[ORM\Column(type: 'boolean', options: ['default' => false])]`
   - Getter: `public function isAllowOverlap(): bool { return $this->allowOverlap ?? false; }`
   - Setter: `public function setAllowOverlap(bool $allowOverlap): static`

2. Generate migration using Symfony console:
   ```bash
   docker compose exec php bin/console doctrine:migrations:diff
   ```

3. Run the migration:
   ```bash
   docker compose exec php bin/console doctrine:migrations:migrate --no-interaction
   ```

Default to `false` - events do NOT allow overlap unless explicitly set to true. This is the conservative approach.
  </action>
  <verify>
    - `docker compose exec php bin/console doctrine:schema:validate` shows no errors
    - `docker compose exec php bin/console dbal:run-sql "SELECT allow_overlap FROM events LIMIT 1"` runs without error
  </verify>
  <done>
    - Event entity has `allowOverlap` property with getter/setter
    - Migration file exists and has been applied
    - Database has `allow_overlap` column on events table (default false)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PlanningScheduleGenerator to include allowOverlap in event data</name>
  <files>backend/src/Service/PlanningScheduleGenerator.php</files>
  <action>
Update both `generate()` and `generateRebuild()` methods to include `allowOverlap` in event data.

In `generate()` method (around line 54-59), update the eventData mapping:
```php
$eventData = array_map(fn (Event $event) => [
    'id' => $event->getId(),
    'title' => $event->getTitle(),
    'startTime' => $event->getStartTime()?->format('H:i'),
    'endTime' => $event->getEndTime()?->format('H:i'),
    'allowOverlap' => $event->isAllowOverlap(),  // ADD THIS
], $events);
```

In `generateRebuild()` method (around line 150-155), update the eventData mapping:
```php
$eventData = array_map(fn (Event $event) => [
    'id' => $event->getId(),
    'title' => $event->getTitle(),
    'startTime' => $event->getStartTime()?->format('H:i'),
    'endTime' => $event->getEndTime()?->format('H:i'),
    'allowOverlap' => $event->isAllowOverlap(),  // ADD THIS
], $events);
```
  </action>
  <verify>
    - `grep -n "allowOverlap" backend/src/Service/PlanningScheduleGenerator.php` shows two occurrences
  </verify>
  <done>
    - Both generate() and generateRebuild() methods include allowOverlap in event data
    - Event data passed to Twig templates includes allowOverlap property
  </done>
</task>

<task type="auto">
  <name>Task 3: Update all AI prompt templates with overlap constraints</name>
  <files>
    backend/templates/prompts/schedule_optimization_en.twig
    backend/templates/prompts/schedule_optimization_pl.twig
    backend/templates/prompts/schedule_rebuild_en.twig
    backend/templates/prompts/schedule_rebuild_pl.twig
  </files>
  <action>
**English optimization template (schedule_optimization_en.twig):**

Update the FIXED EVENTS section (lines 8-16) to show overlap status:
```twig
FIXED EVENTS (cannot be moved):
{% if events|length > 0 %}
{% for event in events %}
- [ID: {{ event.id }}] {{ event.title }}: {{ event.startTime }}{% if event.endTime %} - {{ event.endTime }}{% endif %}{% if event.allowOverlap %} [ALLOWS TASK OVERLAP]{% else %} [NO OVERLAP - DO NOT SCHEDULE TASKS HERE]{% endif %}

{% endfor %}
{% else %}
(No events scheduled)
{% endif %}
```

Add a new constraint rule after the existing CRITICAL RULES section (before line 57):
```
EVENT OVERLAP RULES:
- Events marked [NO OVERLAP] are BLOCKED time slots - treat them like already scheduled tasks!
- ONLY events marked [ALLOWS TASK OVERLAP] can have tasks scheduled during them
- Even then, the task MUST have canCombineWithEvents including that event's ID
- If a task has canCombineWithEvents but the event has [NO OVERLAP], DO NOT combine them
```

**Polish optimization template (schedule_optimization_pl.twig):**

Update the STALE WYDARZENIA section similarly:
```twig
STALE WYDARZENIA (nie mozna przesuwac):
{% if events|length > 0 %}
{% for event in events %}
- [ID: {{ event.id }}] {{ event.title }}: {{ event.startTime }}{% if event.endTime %} - {{ event.endTime }}{% endif %}{% if event.allowOverlap %} [POZWALA NA NAKLADANIE ZADAN]{% else %} [BEZ NAKLADANIA - NIE PLANUJ TU ZADAN]{% endif %}

{% endfor %}
{% else %}
(Brak zaplanowanych wydarzen)
{% endif %}
```

Add Polish constraint rules:
```
ZASADY NAKLADANIA WYDARZEN:
- Wydarzenia z [BEZ NAKLADANIA] to ZABLOKOWANE sloty - traktuj je jak juz zaplanowane zadania!
- TYLKO wydarzenia z [POZWALA NA NAKLADANIE ZADAN] moga miec zadania zaplanowane podczas nich
- Nawet wtedy zadanie MUSI miec canCombineWithEvents zawierajace ID tego wydarzenia
- Jesli zadanie ma canCombineWithEvents ale wydarzenie ma [BEZ NAKLADANIA], NIE lacz ich
```

**English rebuild template (schedule_rebuild_en.twig):**

Update the FIXED EVENTS section (lines 9-17) similarly to optimization template.

**Polish rebuild template (schedule_rebuild_pl.twig):**

Update the STALE WYDARZENIA section (lines 9-17) similarly to optimization template.

Note: Rebuild templates are simpler and don't have canCombineWithEvents logic, but still need to show which events are blocked.
  </action>
  <verify>
    - `grep -l "allowOverlap" backend/templates/prompts/*.twig | wc -l` equals 4
    - `grep "NO OVERLAP" backend/templates/prompts/schedule_optimization_en.twig` returns match
    - `grep "BEZ NAKLADANIA" backend/templates/prompts/schedule_optimization_pl.twig` returns match
  </verify>
  <done>
    - All 4 prompt templates show event overlap status
    - English templates have [ALLOWS TASK OVERLAP] / [NO OVERLAP] markers
    - Polish templates have equivalent Polish markers
    - Constraint rules added to optimization templates
  </done>
</task>

<task type="auto">
  <name>Task 4: Update frontend Event type</name>
  <files>frontend/src/types/index.ts</files>
  <action>
Update the Event interface (around line 122-128) to include allowOverlap:

```typescript
export interface Event {
  id?: number;
  title: string;
  startTime: string;
  endTime: string | null;
  date: string;
  allowOverlap?: boolean;  // ADD THIS - optional for backward compatibility
}
```

The property is optional (`allowOverlap?: boolean`) because:
- Existing events from API may not have it set
- Default is false, so undefined/missing is treated as false
  </action>
  <verify>
    - `grep "allowOverlap" frontend/src/types/index.ts` shows the property in Event interface
  </verify>
  <done>
    - Event interface has allowOverlap?: boolean property
    - TypeScript compilation passes (npm run build in frontend)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Database verification:
   ```bash
   docker compose exec php bin/console doctrine:schema:validate
   ```

2. Backend syntax check:
   ```bash
   docker compose exec php vendor/bin/phpstan analyse src --level=5 2>&1 | head -20
   ```

3. Frontend build:
   ```bash
   cd frontend && npm run build
   ```

4. Functional test: Create an event via brain dump, verify it has allowOverlap=false by default.
</verification>

<success_criteria>
- Event entity has allowOverlap property with default false
- Migration applied successfully
- PlanningScheduleGenerator passes allowOverlap to prompts
- All 4 prompt templates show overlap status and have constraint rules
- Frontend Event type includes allowOverlap
- No TypeScript or PHP errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-planning-fixes/08-01-SUMMARY.md`
</output>
