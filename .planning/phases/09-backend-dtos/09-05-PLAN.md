---
phase: 09-backend-dtos
plan: 05
type: execute
wave: 3
depends_on: ["09-01", "09-03"]
files_modified:
  - backend/src/Controller/TaskController.php
  - backend/src/Controller/TaskSplitController.php
  - backend/src/Controller/EventController.php
  - backend/src/Controller/TimeBlockController.php
  - backend/src/Controller/NoteController.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "TaskController uses TaskResponse::fromEntity() for all task responses"
    - "TaskSplitController.serializeTask() method is removed"
    - "EventController uses EventResponse::fromEntity() for all event responses"
    - "TimeBlockController.serializeTimeBlock() method is removed"
    - "NoteController uses NoteResponse::fromEntity() for all note responses"
    - "API responses are identical before and after (backward compatible)"
  artifacts:
    - path: "backend/src/Controller/TaskController.php"
      provides: "Task CRUD using Response DTOs"
      contains: "TaskResponse::fromEntity"
    - path: "backend/src/Controller/EventController.php"
      provides: "Event CRUD using Response DTOs"
      contains: "EventResponse::fromEntity"
    - path: "backend/src/Controller/TimeBlockController.php"
      provides: "TimeBlock CRUD using Response DTOs"
      contains: "TimeBlockResponse::fromEntity"
  key_links:
    - from: "TaskController"
      to: "TaskResponse"
      via: "use statement and fromEntity() calls"
    - from: "EventController"
      to: "EventResponse"
      via: "use statement and fromEntity() calls"
---

<objective>
Integrate Response DTOs into controllers, replacing inline array serialization and private serialize methods.

Purpose: This is the primary goal of Phase 9 - eliminate duplicated serialization code by using centralized DTOs.

Output: Updated controllers using Response DTOs, with removed duplicate serialize methods.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-backend-dtos/09-RESEARCH.md

Depends on Plan 01 (TagResponse, EventResponse, NoteResponse) and Plan 03 (TaskResponse, TimeBlockResponse).

Files to update:
1. TaskController.php - replace inline arrays with TaskResponse::fromEntity()
2. TaskSplitController.php - remove serializeTask(), use TaskResponse::fromEntity()
3. EventController.php - replace inline arrays with EventResponse::fromEntity()
4. TimeBlockController.php - remove serializeTimeBlock(), use TimeBlockResponse::fromEntity()
5. NoteController.php - remove serializeNote(), use NoteResponse::fromEntity()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TaskController to use TaskResponse</name>
  <files>
    backend/src/Controller/TaskController.php
  </files>
  <action>
Add use statement:
```php
use App\DTO\Response\TaskResponse;
```

Replace inline arrays in create() (lines 73-93):
```php
// Before:
return $this->json([
    'id' => $task->getId(),
    ...
], Response::HTTP_CREATED);

// After:
return $this->json(TaskResponse::fromEntity($task), Response::HTTP_CREATED);
```

Replace inline arrays in update() (lines 182-206):
```php
// Before:
$response = [
    'id' => $task->getId(),
    ...
];

// After:
$response = TaskResponse::fromEntity($task);
```

IMPORTANT: The update() method has special handling for `generatedNextTask` (lines 209-215). Keep this logic but modify to add to array representation:
```php
$responseData = (array) TaskResponse::fromEntity($task);
if ($generatedNextTask !== null) {
    $responseData['generatedNextTask'] = [
        'id' => $generatedNextTask->getId(),
        'title' => $generatedNextTask->getTitle(),
        'date' => $generatedNextTask->getDailyNote()?->getDate()?->format('Y-m-d'),
    ];
}
return $this->json($responseData);
```

Note: Using (array) cast on readonly object works because Symfony's JsonResponse serializes public properties.

Actually, better approach - just return the DTO and handle generatedNextTask separately since it's an edge case. Use a combined response:
```php
return $this->json([
    'task' => TaskResponse::fromEntity($task),
    'generatedNextTask' => $generatedNextTask ? [
        'id' => $generatedNextTask->getId(),
        'title' => $generatedNextTask->getTitle(),
        'date' => $generatedNextTask->getDailyNote()?->getDate()?->format('Y-m-d'),
    ] : null,
]);
```

Wait - this changes the API structure. Keep backward compatibility:

For update(), the response is the task directly (not wrapped). The generatedNextTask is added as an extra field. Since TaskResponse is readonly, we need to handle this carefully.

Solution: Use json_decode(json_encode()) or create a helper. Simplest: serialize then add field:
```php
$taskData = json_decode(json_encode(TaskResponse::fromEntity($task)), true);
if ($generatedNextTask !== null) {
    $taskData['generatedNextTask'] = [...];
}
return $this->json($taskData);
```

This is slightly ugly but maintains backward compatibility. A cleaner approach would be to have the DTO handle this, but that's out of scope.
  </action>
  <verify>Run `docker compose exec php php -l backend/src/Controller/TaskController.php` for syntax check. Manually test: `curl -X POST http://localhost:8080/api/task -H "Content-Type: application/json" -d '{"title":"test","date":"2024-01-01"}'` (requires auth).</verify>
  <done>TaskController uses TaskResponse::fromEntity() for create and update responses.</done>
</task>

<task type="auto">
  <name>Task 2: Update TaskSplitController, EventController, TimeBlockController, NoteController</name>
  <files>
    backend/src/Controller/TaskSplitController.php
    backend/src/Controller/EventController.php
    backend/src/Controller/TimeBlockController.php
    backend/src/Controller/NoteController.php
  </files>
  <action>
**TaskSplitController.php:**
1. Add `use App\DTO\Response\TaskResponse;`
2. Remove the private `serializeTask()` method (lines 196-222)
3. Replace all calls to `$this->serializeTask($task)` with `TaskResponse::fromEntity($task)`
   - Line 67: `'parentTask' => TaskResponse::fromEntity($task)`
   - Line 68: `'subtasks' => array_map(fn($t) => TaskResponse::fromEntity($t), $subtasks)`
   - Line 97: `return $this->json(TaskResponse::fromEntity($mergedTask));`
   - Line 119: `'subtasks' => array_map(fn($t) => TaskResponse::fromEntity($t), $subtasks)`

**EventController.php:**
1. Add `use App\DTO\Response\EventResponse;`
2. Replace inline array in create() (lines 74-80):
   ```php
   return $this->json(EventResponse::fromEntity($event), Response::HTTP_CREATED);
   ```
3. Replace inline array in update() (lines 122-128):
   ```php
   return $this->json(EventResponse::fromEntity($event));
   ```

**TimeBlockController.php:**
1. Add `use App\DTO\Response\TimeBlockResponse;`
2. Remove the private `serializeTimeBlock()` method (lines 376-393)
3. Replace all calls:
   - Line 48-51: `return $this->json(array_map(fn(TimeBlock $tb) => TimeBlockResponse::fromEntity($tb), $timeBlocks));`
   - Line 140: `return $this->json(TimeBlockResponse::fromEntity($timeBlock), Response::HTTP_CREATED);`
   - Line 215: `return $this->json(TimeBlockResponse::fromEntity($timeBlock));`

**NoteController.php:**
1. Add `use App\DTO\Response\NoteResponse;`
2. Remove the private `serializeNote()` method (lines 149-159)
3. Replace all calls:
   - Line 36: `array_map(fn(Note $note) => NoteResponse::fromEntity($note), $notes)`
   - Line 45: `array_map(fn(Note $note) => NoteResponse::fromEntity($note), $notes)`
   - Line 84: `return $this->json(NoteResponse::fromEntity($note), Response::HTTP_CREATED);`
   - Line 120: `return $this->json(NoteResponse::fromEntity($note));`
  </action>
  <verify>Run syntax checks on all modified files:
```bash
docker compose exec php php -l backend/src/Controller/TaskSplitController.php
docker compose exec php php -l backend/src/Controller/EventController.php
docker compose exec php php -l backend/src/Controller/TimeBlockController.php
docker compose exec php php -l backend/src/Controller/NoteController.php
```
  </verify>
  <done>All four controllers use Response DTOs, with serializeTask(), serializeTimeBlock(), and serializeNote() methods removed.</done>
</task>

</tasks>

<verification>
Run PHPStan on all modified controllers:
```bash
docker compose exec php ./vendor/bin/phpstan analyse backend/src/Controller/TaskController.php backend/src/Controller/TaskSplitController.php backend/src/Controller/EventController.php backend/src/Controller/TimeBlockController.php backend/src/Controller/NoteController.php --level=6
```

Grep for remaining inline serialization:
```bash
grep -n "->getId\(\)" backend/src/Controller/TaskController.php | head -20
```
Should only show ID fetches for queries/comparisons, not for building response arrays.
</verification>

<success_criteria>
1. TaskController uses TaskResponse::fromEntity() in create() and update()
2. TaskSplitController.serializeTask() method is deleted
3. EventController uses EventResponse::fromEntity() in create() and update()
4. TimeBlockController.serializeTimeBlock() method is deleted
5. NoteController.serializeNote() method is deleted
6. PHPStan passes with no errors
7. No private serialize* methods remain in these controllers
</success_criteria>

<output>
After completion, create `.planning/phases/09-backend-dtos/09-05-SUMMARY.md`
</output>
