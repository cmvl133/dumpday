---
phase: 01-backend-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/src/Controller/TimeBlockController.php
autonomous: true

must_haves:
  truths:
    - "GET /api/time-block returns list of user's active time blocks"
    - "POST /api/time-block creates new time block for authenticated user"
    - "PATCH /api/time-block/{id} updates existing time block"
    - "DELETE /api/time-block/{id} soft-deletes time block (sets isActive=false)"
    - "User can only access their own time blocks"
  artifacts:
    - path: "backend/src/Controller/TimeBlockController.php"
      provides: "CRUD endpoints for TimeBlock"
      exports: ["list", "create", "update", "delete"]
      min_lines: 150
  key_links:
    - from: "backend/src/Controller/TimeBlockController.php"
      to: "backend/src/Repository/TimeBlockRepository.php"
      via: "dependency injection"
      pattern: "TimeBlockRepository"
    - from: "backend/src/Controller/TimeBlockController.php"
      to: "backend/src/Entity/TimeBlock.php"
      via: "entity usage"
      pattern: "new TimeBlock"
---

<objective>
Create TimeBlockController with CRUD endpoints following RecurringController pattern

Purpose: Expose TimeBlock management API for frontend consumption
Output: Complete CRUD API at /api/time-block with proper auth, validation, and serialization
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-RESEARCH.md

# Pattern reference - follow this closely
@backend/src/Controller/RecurringController.php
@backend/src/Controller/TagController.php

# Entity from Plan 01
@backend/src/Entity/TimeBlock.php
@backend/src/Repository/TimeBlockRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimeBlockController with List and Create</name>
  <files>
    backend/src/Controller/TimeBlockController.php
  </files>
  <action>
Create TimeBlockController following RecurringController pattern exactly:

**Route prefix:** `/api/time-block`

**Dependencies via constructor:**
- TimeBlockRepository
- TagRepository (for tag assignment)
- EntityManagerInterface

**GET /api/time-block (list):**
- Use `#[CurrentUser] User $user` attribute
- Call `$this->timeBlockRepository->findActiveByUser($user)`
- Return JSON array via `array_map` with serializeTimeBlock

**POST /api/time-block (create):**
- Parse JSON body
- Validate required fields: name, color, startTime, endTime
- Validate color is valid hex (7 chars starting with #)
- Validate recurrenceType using RecurrenceType::tryFrom()
- Create TimeBlock, set user, persist, flush
- Handle tag IDs if provided: fetch tags by ID, verify user ownership, add to block
- Return 201 with serialized block

**Serialization method (private):**
```php
private function serializeTimeBlock(TimeBlock $tb): array
{
    return [
        'id' => $tb->getId(),
        'name' => $tb->getName(),
        'color' => $tb->getColor(),
        'startTime' => $tb->getStartTime()?->format('H:i'),
        'endTime' => $tb->getEndTime()?->format('H:i'),
        'recurrenceType' => $tb->getRecurrenceType()->value,
        'recurrenceDays' => $tb->getRecurrenceDays(),
        'isActive' => $tb->isActive(),
        'createdAt' => $tb->getCreatedAt()?->format('c'),
        'tags' => array_map(fn ($tag) => [
            'id' => $tag->getId(),
            'name' => $tag->getName(),
            'color' => $tag->getColor(),
        ], $tb->getTags()->toArray()),
    ];
}
```

**Color validation (use TagController pattern):**
```php
private const ALLOWED_COLORS = [
    '#ef4444', '#f97316', '#f59e0b', '#eab308',
    '#84cc16', '#22c55e', '#10b981', '#14b8a6',
    '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1',
    '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
    '#f43f5e', '#78716c',
];
```
  </action>
  <verify>
Run: `docker compose exec php bin/console debug:router | grep time-block`
Should show time_block_list (GET) and time_block_create (POST) routes
  </verify>
  <done>
TimeBlockController exists with list and create endpoints. Routes registered in router.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Update and Delete Endpoints</name>
  <files>
    backend/src/Controller/TimeBlockController.php
  </files>
  <action>
Add PATCH and DELETE endpoints to TimeBlockController:

**PATCH /api/time-block/{id} (update):**
- Find TimeBlock by ID, return 404 if not found
- Verify ownership: `$timeBlock->getUser()?->getId() !== $user->getId()` -> 403
- Update only provided fields (use isset for optional, array_key_exists for nullable)
- Fields to update: name, color, startTime, endTime, recurrenceType, recurrenceDays, isActive
- Handle tags separately: if tagIds provided, clear existing tags and add new ones
- Flush and return serialized block

**DELETE /api/time-block/{id} (soft delete):**
- Find TimeBlock by ID, return 404 if not found
- Verify ownership -> 403 if not owner
- Set `$timeBlock->setIsActive(false)` (soft delete, NOT hard delete)
- Flush and return 204 No Content

**Error responses (match RecurringController format):**
```php
return $this->json(['error' => 'Time block not found'], Response::HTTP_NOT_FOUND);
return $this->json(['error' => 'Access denied'], Response::HTTP_FORBIDDEN);
```

**Route attributes:**
```php
#[Route('/{id}', name: 'time_block_update', methods: ['PATCH'])]
#[Route('/{id}', name: 'time_block_delete', methods: ['DELETE'])]
```
  </action>
  <verify>
Run: `docker compose exec php bin/console debug:router | grep time-block`
Should show all 4 routes: list, create, update, delete
  </verify>
  <done>
TimeBlockController has all CRUD endpoints with proper validation and ownership checks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test API Endpoints Manually</name>
  <files>
    (none - testing only)
  </files>
  <action>
Test all endpoints work correctly using curl or similar:

**Note:** This requires authentication. Use existing auth mechanism or test in browser dev tools after logging in.

If unable to test authenticated endpoints, verify at minimum:
1. Routes are registered: `docker compose exec php bin/console debug:router | grep time-block`
2. Controller is valid: `docker compose exec php bin/console lint:container`
3. No syntax errors in controller

**Manual verification checklist:**
- [ ] GET /api/time-block returns 200 (empty array for new user)
- [ ] POST /api/time-block with valid data returns 201
- [ ] POST /api/time-block with invalid color returns 400
- [ ] POST /api/time-block with missing required field returns 400
- [ ] PATCH /api/time-block/{id} updates block, returns 200
- [ ] PATCH another user's block returns 403
- [ ] DELETE /api/time-block/{id} returns 204
- [ ] GET after DELETE shows block is missing (isActive=false filtered out)
  </action>
  <verify>
Run: `docker compose exec php bin/console debug:router | grep time-block`
All 4 routes should be listed
  </verify>
  <done>
All CRUD routes registered and controller passes lint. API ready for frontend integration.
  </done>
</task>

</tasks>

<verification>
1. Routes registered: `docker compose exec php bin/console debug:router | grep time-block`
2. Container valid: `docker compose exec php bin/console lint:container`
3. Controller syntax: `docker compose exec php php -l src/Controller/TimeBlockController.php`
</verification>

<success_criteria>
- TimeBlockController exists at backend/src/Controller/TimeBlockController.php
- GET /api/time-block returns user's active time blocks
- POST /api/time-block creates time block with validation
- PATCH /api/time-block/{id} updates time block with ownership check
- DELETE /api/time-block/{id} soft-deletes time block
- Color validation restricts to allowed colors
- Tag assignment works via tagIds array
- All routes registered in Symfony router
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-02-SUMMARY.md`
</output>
