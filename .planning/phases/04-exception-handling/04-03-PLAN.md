---
phase: 04-exception-handling
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - frontend/src/types/index.ts
  - frontend/src/lib/api.ts
  - frontend/src/components/schedule/TimeBlockStrip.tsx
  - frontend/src/i18n/locales/en.json
  - frontend/src/i18n/locales/pl.json
autonomous: true

must_haves:
  truths:
    - "User sees 'Skip today' button in block tooltip"
    - "User can click 'Skip today' and block disappears from schedule"
    - "User sees time inputs to modify block times for today"
    - "User sees visual indicator (dashed border) for modified blocks"
    - "User sees 'Restore' button for exception blocks to undo changes"
    - "Next day shows original template (exception is date-specific)"
  artifacts:
    - path: "frontend/src/types/index.ts"
      provides: "TimeBlock type with isException, originalStartTime, originalEndTime"
      contains: "isException"
    - path: "frontend/src/lib/api.ts"
      provides: "skipForDate, modifyForDate, restoreForDate API methods"
      contains: ["skipForDate", "modifyForDate", "restoreForDate"]
    - path: "frontend/src/components/schedule/TimeBlockStrip.tsx"
      provides: "Skip/modify UI in tooltip, visual exception indicator"
      contains: ["Skip today", "isException"]
    - path: "frontend/src/i18n/locales/en.json"
      provides: "English translations for exception UI"
      contains: "skipToday"
    - path: "frontend/src/i18n/locales/pl.json"
      provides: "Polish translations for exception UI"
      contains: "skipToday"
  key_links:
    - from: "TimeBlockStrip onSkip"
      to: "api.timeBlock.skipForDate"
      via: "callback prop from parent"
      pattern: "onSkip"
    - from: "TimeBlockStrip onModify"
      to: "api.timeBlock.modifyForDate"
      via: "callback prop from parent"
      pattern: "onModify"
---

<objective>
Add frontend support for time block exceptions: skip/modify UI in tooltip, visual indicator for exceptions, API integration.

Purpose: Enable users to skip or modify blocks for the current day directly from the schedule view, with clear visual feedback.

Output: TimeBlockStrip with skip/modify actions, API methods, i18n translations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-exception-handling/04-RESEARCH.md
@.planning/phases/04-exception-handling/04-02-SUMMARY.md

@frontend/src/types/index.ts
@frontend/src/lib/api.ts
@frontend/src/components/schedule/TimeBlockStrip.tsx
@frontend/src/i18n/locales/en.json
@frontend/src/i18n/locales/pl.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Types and API Client</name>
  <files>
    frontend/src/types/index.ts
    frontend/src/lib/api.ts
  </files>
  <action>
1. Update TimeBlock interface in types/index.ts:
   Add optional fields for exception state:
   ```typescript
   export interface TimeBlock {
     // ... existing fields ...
     isException?: boolean;
     originalStartTime?: string;  // Original time when overridden
     originalEndTime?: string;
   }
   ```

2. Add exception methods to api.ts timeBlock section:

   ```typescript
   skipForDate: async (id: number, date: string): Promise<{ success: boolean; date: string }> => {
     const response = await fetch(`${API_BASE}/time-block/${id}/skip`, {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ date }),
       credentials: 'include',
     });
     if (!response.ok) {
       const error = await response.json().catch(() => ({}));
       throw new Error(error.error || 'Failed to skip time block');
     }
     return response.json();
   },

   modifyForDate: async (
     id: number,
     date: string,
     data: { startTime?: string; endTime?: string }
   ): Promise<{ success: boolean; date: string; startTime?: string; endTime?: string }> => {
     const response = await fetch(`${API_BASE}/time-block/${id}/modify`, {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ date, ...data }),
       credentials: 'include',
     });
     if (!response.ok) {
       const error = await response.json().catch(() => ({}));
       throw new Error(error.error || 'Failed to modify time block');
     }
     return response.json();
   },

   restoreForDate: async (id: number, date: string): Promise<{ success: boolean }> => {
     const response = await fetch(`${API_BASE}/time-block/${id}/exception?date=${encodeURIComponent(date)}`, {
       method: 'DELETE',
       credentials: 'include',
     });
     if (!response.ok) {
       const error = await response.json().catch(() => ({}));
       throw new Error(error.error || 'Failed to restore time block');
     }
     return response.json();
   },
   ```
  </action>
  <verify>TypeScript compilation: `cd frontend && npm run build` - no type errors</verify>
  <done>TimeBlock type has isException fields, API has skipForDate/modifyForDate/restoreForDate methods</done>
</task>

<task type="auto">
  <name>Task 2: Update TimeBlockStrip with Exception UI</name>
  <files>frontend/src/components/schedule/TimeBlockStrip.tsx</files>
  <action>
Enhance TimeBlockStrip with skip/modify/restore actions:

1. Add imports:
   ```typescript
   import { useState } from 'react';
   import { Pencil, X, Check, RotateCcw, Clock } from 'lucide-react';
   import { Button } from '@/components/ui/button';
   import { Input } from '@/components/ui/input';
   import { useTranslation } from 'react-i18next';
   ```

2. Update props interface:
   ```typescript
   interface TimeBlockStripProps {
     block: TimeBlock;
     topPercent: number;
     heightPercent: number;
     date: string;  // NEW - needed for API calls
     onEdit?: (block: TimeBlock) => void;
     onSkip?: (blockId: number, date: string) => void;  // NEW
     onModify?: (blockId: number, date: string, data: { startTime: string; endTime: string }) => void;  // NEW
     onRestore?: (blockId: number, date: string) => void;  // NEW
   }
   ```

3. Add local state for edit mode:
   ```typescript
   const [isEditingTime, setIsEditingTime] = useState(false);
   const [editStartTime, setEditStartTime] = useState(block.startTime);
   const [editEndTime, setEditEndTime] = useState(block.endTime);
   ```

4. Add visual indicator for exceptions - modify the diagonal stripe div:
   ```typescript
   <div
     className={cn(
       'absolute inset-0 rounded-sm transition-all hover:brightness-125',
       block.isException && 'border-2 border-dashed'
     )}
     style={{
       background: `repeating-linear-gradient(
         45deg,
         ${block.color}15,
         ${block.color}15 6px,
         ${block.color}${block.isException ? '25' : '35'} 6px,
         ${block.color}${block.isException ? '25' : '35'} 12px
       )`,
       borderLeft: `3px solid ${block.color}`,
       borderColor: block.isException ? block.color : undefined,
     }}
   />
   ```

5. Enhance tooltip content with actions:
   - Show original times if modified: "(was: {originalStartTime} - {originalEndTime})"
   - Show "Skip today" button (X icon) when NOT an exception
   - Show "Edit times" button (Clock icon) when NOT in edit mode
   - Show time inputs when in edit mode
   - Show "Restore" button (RotateCcw icon) when IS an exception

6. Time edit mode UI:
   ```tsx
   {isEditingTime ? (
     <div className="space-y-2 mt-2">
       <div className="flex gap-2 items-center">
         <Input
           type="time"
           value={editStartTime}
           onChange={(e) => setEditStartTime(e.target.value)}
           className="h-7 text-xs w-20"
         />
         <span className="text-xs text-muted-foreground">-</span>
         <Input
           type="time"
           value={editEndTime}
           onChange={(e) => setEditEndTime(e.target.value)}
           className="h-7 text-xs w-20"
         />
       </div>
       <div className="flex gap-1">
         <Button
           size="sm"
           className="h-6 text-xs"
           onClick={(e) => {
             e.stopPropagation();
             onModify?.(block.id, date, { startTime: editStartTime, endTime: editEndTime });
             setIsEditingTime(false);
           }}
         >
           <Check className="h-3 w-3 mr-1" />
           {t('common.save')}
         </Button>
         <Button
           variant="ghost"
           size="sm"
           className="h-6 text-xs"
           onClick={(e) => {
             e.stopPropagation();
             setIsEditingTime(false);
             setEditStartTime(block.startTime);
             setEditEndTime(block.endTime);
           }}
         >
           <X className="h-3 w-3" />
         </Button>
       </div>
     </div>
   ) : (
     <div className="flex flex-wrap gap-1 mt-2">
       {!block.isException && (
         <>
           <Button
             variant="ghost"
             size="sm"
             className="h-6 text-xs"
             onClick={(e) => {
               e.stopPropagation();
               onSkip?.(block.id, date);
             }}
           >
             <X className="h-3 w-3 mr-1" />
             {t('timeBlocks.skipToday')}
           </Button>
           <Button
             variant="ghost"
             size="sm"
             className="h-6 text-xs"
             onClick={(e) => {
               e.stopPropagation();
               setIsEditingTime(true);
             }}
           >
             <Clock className="h-3 w-3 mr-1" />
             {t('timeBlocks.editTimes')}
           </Button>
         </>
       )}
       {block.isException && (
         <Button
           variant="ghost"
           size="sm"
           className="h-6 text-xs"
           onClick={(e) => {
             e.stopPropagation();
             onRestore?.(block.id, date);
           }}
         >
           <RotateCcw className="h-3 w-3 mr-1" />
           {t('timeBlocks.restore')}
         </Button>
       )}
     </div>
   )}
   ```

7. Widen tooltip in edit mode:
   Change tooltip width to accommodate inputs when editing:
   ```tsx
   className={cn(
     'absolute left-full ml-2 top-0 bg-popover border rounded-lg shadow-lg px-3 py-2 z-[100]',
     isEditingTime ? 'w-[260px]' : 'w-[220px]'
   )}
   ```
  </action>
  <verify>
Build frontend: `cd frontend && npm run build` - no errors
Visual check: Hover over time block, see Skip/Edit buttons
  </verify>
  <done>
- TimeBlockStrip shows Skip/Edit buttons in tooltip
- Time edit mode with inputs and save/cancel
- Dashed border indicator for exception blocks
- Restore button for exception blocks
- Shows original times when modified
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire Callbacks in Parent and Add i18n</name>
  <files>
    frontend/src/components/schedule/TimeBlockBackground.tsx
    frontend/src/components/schedule/DaySchedule.tsx
    frontend/src/components/schedule/ScheduleExpandedModal.tsx
    frontend/src/i18n/locales/en.json
    frontend/src/i18n/locales/pl.json
  </files>
  <action>
1. Add i18n translations in en.json under "timeBlocks" key:
   ```json
   "skipToday": "Skip today",
   "editTimes": "Edit times",
   "restore": "Restore",
   "wasOriginal": "was: {{start}} - {{end}}",
   "modifiedForToday": "Modified for today"
   ```

2. Add i18n translations in pl.json under "timeBlocks" key:
   ```json
   "skipToday": "Pomi\u0144 dzisiaj",
   "editTimes": "Zmie\u0144 godziny",
   "restore": "Przywr\u00f3\u0107",
   "wasOriginal": "by\u0142o: {{start}} - {{end}}",
   "modifiedForToday": "Zmodyfikowane na dzisiaj"
   ```

3. Update TimeBlockBackground.tsx:
   - Add props: date, onSkip, onModify, onRestore
   - Pass these to TimeBlockStrip

4. Update DaySchedule.tsx:
   - Add handler functions that call API and refetch dailyNote
   - Pass handlers to TimeBlockBackground

5. Update ScheduleExpandedModal.tsx:
   - Same pattern as DaySchedule

Handler pattern in DaySchedule/ScheduleExpandedModal:
```tsx
const handleSkipBlock = async (blockId: number, date: string) => {
  try {
    await api.timeBlock.skipForDate(blockId, date);
    // Refetch dailyNote to get updated timeBlocks
    // The parent App.tsx handles refetch when date changes
    // For immediate update, need to call refetch function passed as prop
    onRefetch?.();
  } catch (error) {
    console.error('Failed to skip block:', error);
  }
};

const handleModifyBlock = async (
  blockId: number,
  date: string,
  data: { startTime: string; endTime: string }
) => {
  try {
    await api.timeBlock.modifyForDate(blockId, date, data);
    onRefetch?.();
  } catch (error) {
    console.error('Failed to modify block:', error);
  }
};

const handleRestoreBlock = async (blockId: number, date: string) => {
  try {
    await api.timeBlock.restoreForDate(blockId, date);
    onRefetch?.();
  } catch (error) {
    console.error('Failed to restore block:', error);
  }
};
```

Note: Check if DaySchedule/ScheduleExpandedModal have a refetch prop. If not, the handlers should trigger a dailyNote refetch via a new prop or by dispatching a Redux action. Look at how onEditBlock is handled and follow that pattern.
  </action>
  <verify>
1. Build: `cd frontend && npm run build` - no errors
2. Manual test:
   - Open app, navigate to day with time blocks
   - Hover over block, see "Skip today" and "Edit times" buttons
   - Click "Skip today" - block should disappear
   - Create another block, click "Edit times", change time, save
   - Block should show new times and dashed border
   - Click "Restore" - block should show original times, no dashed border
  </verify>
  <done>
- i18n translations added in en.json and pl.json
- Callbacks wired from schedule components to API
- Skip/modify/restore actions work end-to-end
  </done>
</task>

</tasks>

<verification>
1. TypeScript build passes: `cd frontend && npm run build`
2. Skip action: Click "Skip today" - block disappears for that day only
3. Modify action: Edit times - block shows new times with dashed border
4. Restore action: Click "Restore" - block returns to original times
5. Visual indicator: Modified blocks have dashed border and lighter stripes
6. i18n: Switch to Polish, verify translations appear
7. Persistence: Refresh page - exception state preserved
8. Date isolation: Navigate to tomorrow - block shows original times
</verification>

<success_criteria>
- TimeBlock type includes isException and original time fields
- API methods skipForDate, modifyForDate, restoreForDate work
- TimeBlockStrip shows skip/modify/restore actions in tooltip
- Visual dashed border indicates exception blocks
- i18n translations for en and pl added
- End-to-end flow works: skip -> disappears, modify -> new times, restore -> original
</success_criteria>

<output>
After completion, create `.planning/phases/04-exception-handling/04-03-SUMMARY.md`
</output>
