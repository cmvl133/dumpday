---
phase: 04-exception-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/Entity/TimeBlockException.php
  - backend/src/Repository/TimeBlockExceptionRepository.php
  - backend/migrations/VersionXXXX.php
autonomous: true

must_haves:
  truths:
    - "TimeBlockException entity exists with all required fields"
    - "Unique constraint prevents duplicate exceptions per block per date"
    - "CASCADE delete removes exceptions when parent TimeBlock deleted"
  artifacts:
    - path: "backend/src/Entity/TimeBlockException.php"
      provides: "TimeBlockException entity with timeBlock, exceptionDate, isSkipped, overrideStartTime, overrideEndTime"
      contains: "class TimeBlockException"
    - path: "backend/src/Repository/TimeBlockExceptionRepository.php"
      provides: "Query methods for finding exceptions by user/date and timeBlock/date"
      exports: ["findByUserAndDate", "findByTimeBlockAndDate"]
    - path: "backend/migrations/Version*.php"
      provides: "Database migration for time_block_exceptions table"
      contains: "time_block_exceptions"
  key_links:
    - from: "TimeBlockException"
      to: "TimeBlock"
      via: "ManyToOne with CASCADE delete"
      pattern: "onDelete.*CASCADE"
---

<objective>
Create TimeBlockException entity and repository for storing per-day overrides to time blocks.

Purpose: Foundation for exception handling - allows storing skip/modify state per block per date without affecting the template.

Output: TimeBlockException entity, repository with query methods, database migration applied.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-exception-handling/04-RESEARCH.md

@backend/src/Entity/TimeBlock.php
@backend/src/Repository/TimeBlockRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimeBlockException Entity</name>
  <files>backend/src/Entity/TimeBlockException.php</files>
  <action>
Create TimeBlockException entity following TimeBlock.php pattern:

1. Entity with fields:
   - id (int, auto-generated)
   - timeBlock (ManyToOne to TimeBlock, not nullable, CASCADE delete)
   - exceptionDate (DATE_MUTABLE, not nullable)
   - isSkipped (boolean, default false)
   - overrideStartTime (TIME_MUTABLE, nullable)
   - overrideEndTime (TIME_MUTABLE, nullable)
   - createdAt (DATETIME_IMMUTABLE, set via PrePersist)

2. Add UniqueConstraint on [time_block_id, exception_date] named 'time_block_date_unique'

3. Use table name 'time_block_exceptions'

4. Include standard getters/setters following existing patterns

Key patterns from TimeBlock.php:
- Use `#[ORM\HasLifecycleCallbacks]`
- Use `#[ORM\PrePersist]` for createdAt
- JoinColumn with `onDelete: 'CASCADE'`
  </action>
  <verify>Run `php bin/console lint:container` to verify entity is valid</verify>
  <done>TimeBlockException.php exists with all fields, relationships, and unique constraint</done>
</task>

<task type="auto">
  <name>Task 2: Create TimeBlockExceptionRepository</name>
  <files>backend/src/Repository/TimeBlockExceptionRepository.php</files>
  <action>
Create repository following TimeBlockRepository.php pattern:

1. Extend ServiceEntityRepository for TimeBlockException

2. Add method `findByUserAndDate(User $user, \DateTimeInterface $date): array`
   - Join with timeBlock to filter by user
   - Compare exceptionDate using format('Y-m-d') to avoid time issues
   - Return array of TimeBlockException

3. Add method `findByTimeBlockAndDate(TimeBlock $timeBlock, \DateTimeInterface $date): ?TimeBlockException`
   - Filter by timeBlock and exceptionDate
   - Return single result or null (getOneOrNullResult)

Use DATE_MUTABLE comparison: `->setParameter('date', $date->format('Y-m-d'))`
  </action>
  <verify>Run `php bin/console lint:container` - no errors</verify>
  <done>Repository exists with findByUserAndDate and findByTimeBlockAndDate methods</done>
</task>

<task type="auto">
  <name>Task 3: Generate and Apply Migration</name>
  <files>backend/migrations/VersionXXXX.php</files>
  <action>
Generate and apply database migration:

1. Run inside php container: `php bin/console doctrine:migrations:diff`
   - This generates migration for time_block_exceptions table
   - Should create table with columns: id, time_block_id, exception_date, is_skipped, override_start_time, override_end_time, created_at
   - Should add foreign key to time_blocks with CASCADE delete
   - Should add unique index on (time_block_id, exception_date)

2. Review generated migration for correctness

3. Apply migration: `php bin/console doctrine:migrations:migrate --no-interaction`

4. Verify table exists: `php bin/console doctrine:schema:validate`
  </action>
  <verify>
Run `docker compose exec php php bin/console doctrine:schema:validate` shows no sync issues.
Run `docker compose exec php php bin/console doctrine:query:sql "SELECT column_name FROM information_schema.columns WHERE table_name = 'time_block_exceptions'"` shows all columns.
  </verify>
  <done>Migration applied, time_block_exceptions table exists with correct schema</done>
</task>

</tasks>

<verification>
1. Entity lint passes: `docker compose exec php php bin/console lint:container`
2. Schema valid: `docker compose exec php php bin/console doctrine:schema:validate`
3. Table has unique constraint: Check migration includes unique index on time_block_id + exception_date
4. CASCADE works: Verify onDelete: 'CASCADE' in entity annotation
</verification>

<success_criteria>
- TimeBlockException entity created with all required fields
- Repository has findByUserAndDate and findByTimeBlockAndDate methods
- Migration generated and applied successfully
- Unique constraint on (timeBlock, exceptionDate) enforced
- CASCADE delete configured for TimeBlock relationship
</success_criteria>

<output>
After completion, create `.planning/phases/04-exception-handling/04-01-SUMMARY.md`
</output>
