---
phase: 04-exception-handling
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/src/Service/TimeBlockService.php
  - backend/src/Controller/TimeBlockController.php
autonomous: true

must_haves:
  truths:
    - "User can skip a block for a specific date via API"
    - "User can modify block times for a specific date via API"
    - "User can restore (undo) an exception via API"
    - "GET /time-block/for-date returns effective times with isException flag"
    - "Skipped blocks do not appear in for-date response"
  artifacts:
    - path: "backend/src/Service/TimeBlockService.php"
      provides: "Exception-aware block computation"
      contains: "isException"
    - path: "backend/src/Controller/TimeBlockController.php"
      provides: "Skip, modify, and restore endpoints"
      contains: ["skip", "modify", "exception"]
  key_links:
    - from: "TimeBlockController::skip"
      to: "TimeBlockExceptionRepository"
      via: "findByTimeBlockAndDate or create new"
      pattern: "findByTimeBlockAndDate"
    - from: "TimeBlockService::getActiveBlocksForDate"
      to: "TimeBlockExceptionRepository::findByUserAndDate"
      via: "Load exceptions and apply to blocks"
      pattern: "findByUserAndDate"
---

<objective>
Modify TimeBlockService to apply exceptions when returning blocks for a date, and add API endpoints for skip/modify/restore actions.

Purpose: Enable backend to handle exception logic - skipping excludes blocks, modifying changes times, restoring removes exception.

Output: Service returns exception-aware block data, API endpoints for CRUD operations on exceptions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-exception-handling/04-RESEARCH.md
@.planning/phases/04-exception-handling/04-01-SUMMARY.md

@backend/src/Service/TimeBlockService.php
@backend/src/Controller/TimeBlockController.php
@backend/src/Entity/TimeBlockException.php
@backend/src/Repository/TimeBlockExceptionRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify TimeBlockService to Apply Exceptions</name>
  <files>backend/src/Service/TimeBlockService.php</files>
  <action>
Modify TimeBlockService::getActiveBlocksForDate to return array of arrays (not entities) with exception data:

1. Inject TimeBlockExceptionRepository in constructor

2. Change return type of getActiveBlocksForDate to return arrays instead of entities:
   ```php
   public function getActiveBlocksForDate(User $user, \DateTimeInterface $date): array
   ```

3. After getting active blocks, load exceptions:
   ```php
   $exceptions = $this->exceptionRepository->findByUserAndDate($user, $date);
   $exceptionMap = [];
   foreach ($exceptions as $exception) {
       $exceptionMap[$exception->getTimeBlock()->getId()] = $exception;
   }
   ```

4. Transform blocks to arrays with exception logic:
   - If block has exception with isSkipped=true, SKIP it (continue)
   - If block has exception with override times, use those instead
   - Include isException flag (true if exception exists and not skipped)
   - Include originalStartTime/originalEndTime if times were overridden

5. Return structure for each block:
   ```php
   [
       'id' => $block->getId(),
       'name' => $block->getName(),
       'color' => $block->getColor(),
       'startTime' => $effectiveStartTime,
       'endTime' => $effectiveEndTime,
       'recurrenceType' => $block->getRecurrenceType()->value,
       'recurrenceDays' => $block->getRecurrenceDays(),
       'isActive' => $block->isActive(),
       'createdAt' => $block->getCreatedAt()?->format('c'),
       'tags' => [...], // serialize tags
       'isException' => $hasException,
       'originalStartTime' => $overrideApplied ? $block->getStartTime()->format('H:i') : null,
       'originalEndTime' => $overrideApplied ? $block->getEndTime()->format('H:i') : null,
   ]
   ```

6. Update sorting to use effectiveStartTime (string comparison works for H:i format)
  </action>
  <verify>
No syntax errors - run `docker compose exec php php bin/console lint:container`
  </verify>
  <done>TimeBlockService returns arrays with isException flag and applies skip/time overrides</done>
</task>

<task type="auto">
  <name>Task 2: Update Controller and Add Exception Endpoints</name>
  <files>backend/src/Controller/TimeBlockController.php</files>
  <action>
Update TimeBlockController:

1. Inject TimeBlockExceptionRepository and EntityManagerInterface in constructor

2. Update getForDate() to return service result directly (now returns arrays, not entities):
   ```php
   $blocks = $this->timeBlockService->getActiveBlocksForDate($user, $dateTime);
   return $this->json($blocks);
   ```

3. Add skip endpoint - POST /api/time-block/{id}/skip:
   ```php
   #[Route('/{id}/skip', name: 'time_block_skip', methods: ['POST'])]
   public function skip(#[CurrentUser] User $user, int $id, Request $request): JsonResponse
   ```
   - Find TimeBlock, validate ownership (403 if not owner, 404 if not found)
   - Parse date from request body (default 'today')
   - Upsert exception: find existing or create new
   - Set isSkipped=true, clear override times
   - Return {success: true, date: 'YYYY-MM-DD'}

4. Add modify endpoint - POST /api/time-block/{id}/modify:
   ```php
   #[Route('/{id}/modify', name: 'time_block_modify', methods: ['POST'])]
   public function modify(#[CurrentUser] User $user, int $id, Request $request): JsonResponse
   ```
   - Find TimeBlock, validate ownership
   - Parse date, startTime, endTime from request body
   - Upsert exception: find existing or create new
   - Set isSkipped=false, set override times
   - Return {success: true, date: 'YYYY-MM-DD', startTime: 'HH:MM', endTime: 'HH:MM'}

5. Add restore endpoint - DELETE /api/time-block/{id}/exception:
   ```php
   #[Route('/{id}/exception', name: 'time_block_restore', methods: ['DELETE'])]
   public function restore(#[CurrentUser] User $user, int $id, Request $request): JsonResponse
   ```
   - Find TimeBlock, validate ownership
   - Parse date from query param
   - Find exception for that date, delete if exists
   - Return {success: true} or 404 if no exception

Validation patterns:
- Use `$this->timeBlockRepository->find($id)` for lookup
- Return 404 with `['error' => 'Time block not found']`
- Return 403 with `['error' => 'Access denied']` for wrong user
- Parse date: `$date = new \DateTime($data['date'] ?? 'today')`
  </action>
  <verify>
Test endpoints manually:
1. Create a time block via Settings UI
2. Call skip: `curl -X POST http://localhost:8080/api/time-block/{id}/skip -d '{"date":"2026-01-20"}' -H "Content-Type: application/json"`
3. Call for-date: verify block not in response
4. Call restore: `curl -X DELETE "http://localhost:8080/api/time-block/{id}/exception?date=2026-01-20"`
5. Call for-date: verify block back in response
  </verify>
  <done>
- POST /api/time-block/{id}/skip creates skip exception
- POST /api/time-block/{id}/modify creates time override exception
- DELETE /api/time-block/{id}/exception removes exception
- GET /api/time-block/for-date/{date} returns blocks with isException flag, excludes skipped
  </done>
</task>

</tasks>

<verification>
1. Container lint: `docker compose exec php php bin/console lint:container`
2. Test skip: Block skipped for date should not appear in for-date response
3. Test modify: Block with modified times should show new times in for-date response
4. Test restore: After restore, block should appear with original times
5. Test isException flag: Modified blocks have isException=true, normal blocks have isException=false
</verification>

<success_criteria>
- TimeBlockService returns arrays with exception logic applied
- Skipped blocks excluded from for-date response
- Modified blocks show override times in for-date response
- isException flag indicates exception state
- Skip/modify/restore endpoints work correctly with ownership validation
</success_criteria>

<output>
After completion, create `.planning/phases/04-exception-handling/04-02-SUMMARY.md`
</output>
