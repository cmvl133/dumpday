---
phase: 11-backend-tests
plan: 05
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - backend/.env.test
  - backend/tests/Integration/Controller/TaskControllerTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "POST /api/task returns 201 with valid data"
    - "POST /api/task returns 422 with invalid data (validation errors)"
    - "GET /api/task/{id} returns 404 for non-existent task"
    - "GET /api/task/{id} returns 403 for other user's task"
    - "PATCH /api/task/{id} updates task fields"
    - "DELETE /api/task/{id} removes task"
    - "Tests use real database with test user"
  artifacts:
    - path: "backend/.env.test"
      provides: "Test database configuration"
      contains: "DATABASE_URL"
    - path: "backend/tests/Integration/Controller/TaskControllerTest.php"
      provides: "Task API integration tests"
      min_lines: 150
  key_links:
    - from: "backend/tests/Integration/Controller/TaskControllerTest.php"
      to: "backend/src/Controller/TaskController.php"
      via: "HTTP requests"
      pattern: "client->request"
    - from: "backend/.env.test"
      to: "docker-compose.yml"
      via: "DATABASE_URL with _test suffix"
      pattern: "dumpday_test"
---

<objective>
Create integration tests for Task API endpoints

Purpose: Verify full HTTP request/response cycle works correctly with real database. Catches integration issues that unit tests miss.

Output: Integration test file testing Task CRUD endpoints with test database
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-backend-tests/11-RESEARCH.md

@backend/src/Controller/TaskController.php
@backend/src/DTO/Request/TaskCreateRequest.php
@backend/src/DTO/Response/TaskResponse.php
@backend/.env
@backend/phpunit.dist.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure test database and create base test class</name>
  <files>backend/.env.test</files>
  <action>
Configure test environment with separate test database.

1. Update backend/.env.test to include DATABASE_URL pointing to test database:
```dotenv
# define your env variables for the test env here
KERNEL_CLASS='App\Kernel'
APP_SECRET='$ecretf0rt3st'

# Test database - use _test suffix to separate from dev database
DATABASE_URL="postgresql://app:secret@database:5432/dumpday_test?serverVersion=16&charset=utf8"
```

Note: The database 'dumpday_test' will be created automatically by Doctrine when running tests.

2. Create the test database if it doesn't exist. Run:
```bash
docker compose exec php bin/console doctrine:database:create --env=test --if-not-exists
docker compose exec php bin/console doctrine:schema:update --env=test --force
```

3. Create directory structure: `backend/tests/Integration/Controller/`

4. Create base test setup. Integration tests will use WebTestCase which provides:
   - HTTP client simulation via createClient()
   - Kernel boot with test environment
   - Access to container services
   - loginUser() for authentication simulation
  </action>
  <verify>
Run: `docker compose exec php bin/console doctrine:database:create --env=test --if-not-exists`
Database created or already exists.
Run: `docker compose exec php bin/console doctrine:schema:update --env=test --force`
Schema updated successfully.
  </verify>
  <done>
Test database configured with _test suffix. Schema synchronized with test environment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Task API integration tests</name>
  <files>backend/tests/Integration/Controller/TaskControllerTest.php</files>
  <action>
Create integration tests for TaskController API endpoints.

1. Set up test class with user creation helper:
```php
namespace App\Tests\Integration\Controller;

use App\Entity\User;
use App\Entity\DailyNote;
use App\Entity\Task;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Test\WebTestCase;
use Symfony\Component\HttpFoundation\Response;
use PHPUnit\Framework\Attributes\Test;

class TaskControllerTest extends WebTestCase
{
    private EntityManagerInterface $entityManager;

    protected function setUp(): void
    {
        parent::setUp();
        self::bootKernel();
        $this->entityManager = static::getContainer()->get(EntityManagerInterface::class);
        $this->cleanDatabase();
    }

    protected function tearDown(): void
    {
        parent::tearDown();
        $this->entityManager->close();
    }

    private function cleanDatabase(): void
    {
        // Clean up test data in correct order (foreign keys)
        $this->entityManager->createQuery('DELETE FROM App\Entity\Task')->execute();
        $this->entityManager->createQuery('DELETE FROM App\Entity\DailyNote')->execute();
        $this->entityManager->createQuery('DELETE FROM App\Entity\User')->execute();
    }

    private function createTestUser(string $email = 'test@example.com'): User
    {
        $user = new User();
        $user->setEmail($email);
        $user->setGoogleId('test-google-id-' . uniqid());

        $this->entityManager->persist($user);
        $this->entityManager->flush();

        return $user;
    }

    private function createDailyNote(User $user, \DateTime $date): DailyNote
    {
        $dailyNote = new DailyNote();
        $dailyNote->setUser($user);
        $dailyNote->setDate($date);

        $this->entityManager->persist($dailyNote);
        $this->entityManager->flush();

        return $dailyNote;
    }

    private function createTask(DailyNote $dailyNote, string $title): Task
    {
        $task = new Task();
        $task->setTitle($title);
        $task->setDailyNote($dailyNote);

        $this->entityManager->persist($task);
        $this->entityManager->flush();

        return $task;
    }
}
```

2. Test POST /api/task (create):
```php
#[Test]
public function createTaskReturns201WithValidData(): void
{
    $client = static::createClient();
    $user = $this->createTestUser();
    $client->loginUser($user);

    $client->request('POST', '/api/task', [], [], [
        'CONTENT_TYPE' => 'application/json',
    ], json_encode([
        'title' => 'New Integration Test Task',
        'date' => '2026-01-22',
    ]));

    $this->assertResponseStatusCodeSame(Response::HTTP_CREATED);

    $response = json_decode($client->getResponse()->getContent(), true);
    $this->assertArrayHasKey('id', $response);
    $this->assertSame('New Integration Test Task', $response['title']);
}

#[Test]
public function createTaskReturns422ForInvalidData(): void
{
    $client = static::createClient();
    $user = $this->createTestUser();
    $client->loginUser($user);

    $client->request('POST', '/api/task', [], [], [
        'CONTENT_TYPE' => 'application/json',
    ], json_encode([
        'title' => '', // Invalid: empty
        'date' => 'invalid-date',
    ]));

    $this->assertResponseStatusCodeSame(Response::HTTP_UNPROCESSABLE_ENTITY);
}

#[Test]
public function createTaskReturns401WithoutAuthentication(): void
{
    $client = static::createClient();

    $client->request('POST', '/api/task', [], [], [
        'CONTENT_TYPE' => 'application/json',
    ], json_encode([
        'title' => 'Test Task',
        'date' => '2026-01-22',
    ]));

    $this->assertResponseStatusCodeSame(Response::HTTP_UNAUTHORIZED);
}
```

3. Test GET /api/task/{id}:
```php
#[Test]
public function getTaskReturns200ForOwnTask(): void
{
    $client = static::createClient();
    $user = $this->createTestUser();
    $dailyNote = $this->createDailyNote($user, new \DateTime('2026-01-22'));
    $task = $this->createTask($dailyNote, 'Get Test Task');

    $client->loginUser($user);
    $client->request('GET', '/api/task/' . $task->getId());

    $this->assertResponseStatusCodeSame(Response::HTTP_OK);

    $response = json_decode($client->getResponse()->getContent(), true);
    $this->assertSame('Get Test Task', $response['title']);
}

#[Test]
public function getTaskReturns404ForNonExistentTask(): void
{
    $client = static::createClient();
    $user = $this->createTestUser();
    $client->loginUser($user);

    $client->request('GET', '/api/task/99999');

    $this->assertResponseStatusCodeSame(Response::HTTP_NOT_FOUND);
}

#[Test]
public function getTaskReturns404ForOtherUsersTask(): void
{
    $client = static::createClient();

    // Create task owned by user1
    $user1 = $this->createTestUser('user1@example.com');
    $dailyNote = $this->createDailyNote($user1, new \DateTime('2026-01-22'));
    $task = $this->createTask($dailyNote, 'User1 Task');

    // Login as user2
    $user2 = $this->createTestUser('user2@example.com');
    $client->loginUser($user2);

    $client->request('GET', '/api/task/' . $task->getId());

    // Should return 404 (not 403) to avoid revealing task existence
    $this->assertResponseStatusCodeSame(Response::HTTP_NOT_FOUND);
}
```

4. Test PATCH /api/task/{id}:
```php
#[Test]
public function updateTaskReturns200WithValidData(): void
{
    $client = static::createClient();
    $user = $this->createTestUser();
    $dailyNote = $this->createDailyNote($user, new \DateTime('2026-01-22'));
    $task = $this->createTask($dailyNote, 'Original Title');

    $client->loginUser($user);
    $client->request('PATCH', '/api/task/' . $task->getId(), [], [], [
        'CONTENT_TYPE' => 'application/json',
    ], json_encode([
        'title' => 'Updated Title',
    ]));

    $this->assertResponseStatusCodeSame(Response::HTTP_OK);

    $response = json_decode($client->getResponse()->getContent(), true);
    $this->assertSame('Updated Title', $response['title']);
}

#[Test]
public function updateTaskCompletionSetsCompletedAt(): void
{
    $client = static::createClient();
    $user = $this->createTestUser();
    $dailyNote = $this->createDailyNote($user, new \DateTime('2026-01-22'));
    $task = $this->createTask($dailyNote, 'Complete Me');

    $client->loginUser($user);
    $client->request('PATCH', '/api/task/' . $task->getId(), [], [], [
        'CONTENT_TYPE' => 'application/json',
    ], json_encode([
        'isCompleted' => true,
    ]));

    $this->assertResponseStatusCodeSame(Response::HTTP_OK);

    $response = json_decode($client->getResponse()->getContent(), true);
    $this->assertTrue($response['isCompleted']);
    $this->assertNotNull($response['completedAt']);
}
```

5. Test DELETE /api/task/{id}:
```php
#[Test]
public function deleteTaskReturns204(): void
{
    $client = static::createClient();
    $user = $this->createTestUser();
    $dailyNote = $this->createDailyNote($user, new \DateTime('2026-01-22'));
    $task = $this->createTask($dailyNote, 'Delete Me');
    $taskId = $task->getId();

    $client->loginUser($user);
    $client->request('DELETE', '/api/task/' . $taskId);

    $this->assertResponseStatusCodeSame(Response::HTTP_NO_CONTENT);

    // Verify task is actually deleted
    $client->request('GET', '/api/task/' . $taskId);
    $this->assertResponseStatusCodeSame(Response::HTTP_NOT_FOUND);
}

#[Test]
public function deleteTaskReturns404ForOtherUsersTask(): void
{
    $client = static::createClient();

    $user1 = $this->createTestUser('user1@example.com');
    $dailyNote = $this->createDailyNote($user1, new \DateTime('2026-01-22'));
    $task = $this->createTask($dailyNote, 'User1 Protected Task');

    $user2 = $this->createTestUser('user2@example.com');
    $client->loginUser($user2);

    $client->request('DELETE', '/api/task/' . $task->getId());

    $this->assertResponseStatusCodeSame(Response::HTTP_NOT_FOUND);
}
```
  </action>
  <verify>
Run: `docker compose exec php ./vendor/bin/phpunit tests/Integration/Controller/TaskControllerTest.php`
All tests pass.
  </verify>
  <done>
Integration tests verify full HTTP cycle: POST creates with 201/422, GET returns 200/404, PATCH updates fields including completion, DELETE removes with 204. User authorization enforced on all endpoints.
  </done>
</task>

</tasks>

<verification>
Run full integration test suite:
```bash
docker compose exec php ./vendor/bin/phpunit tests/Integration/ --testdox
```

Expected: All tests pass, demonstrating API endpoints work correctly with real database.
</verification>

<success_criteria>
1. .env.test has DATABASE_URL pointing to dumpday_test
2. Test database schema synchronized
3. TaskControllerTest.php exists with CRUD endpoint tests
4. POST /api/task tested for success (201) and validation failure (422)
5. GET /api/task/{id} tested for success (200), not found (404), and authorization
6. PATCH /api/task/{id} tested for field updates and completion
7. DELETE /api/task/{id} tested for success (204) and authorization
8. All tests pass with isolated test data
</success_criteria>

<output>
After completion, create `.planning/phases/11-backend-tests/11-05-SUMMARY.md`
</output>
