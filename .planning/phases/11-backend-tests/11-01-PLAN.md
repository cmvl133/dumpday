---
phase: 11-backend-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/Unit/Service/RecurrenceServiceTest.php
  - backend/tests/Unit/Service/DuplicateDetectionServiceTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "RecurrenceService matchesPattern() returns correct boolean for all 5 recurrence types"
    - "RecurrenceService findNextOccurrenceDate() finds next valid date or returns null"
    - "DuplicateDetectionService correctly identifies duplicate tasks by normalized title"
    - "DuplicateDetectionService correctly identifies overlapping events"
    - "DuplicateDetectionService correctly identifies duplicate content"
  artifacts:
    - path: "backend/tests/Unit/Service/RecurrenceServiceTest.php"
      provides: "RecurrenceService unit tests"
      min_lines: 150
    - path: "backend/tests/Unit/Service/DuplicateDetectionServiceTest.php"
      provides: "DuplicateDetectionService unit tests"
      min_lines: 100
  key_links:
    - from: "backend/tests/Unit/Service/RecurrenceServiceTest.php"
      to: "backend/src/Service/RecurrenceService.php"
      via: "direct instantiation"
      pattern: "new RecurrenceService"
    - from: "backend/tests/Unit/Service/DuplicateDetectionServiceTest.php"
      to: "backend/src/Service/DuplicateDetectionService.php"
      via: "direct instantiation"
      pattern: "new DuplicateDetectionService"
---

<objective>
Create unit tests for pure logic services (RecurrenceService, DuplicateDetectionService)

Purpose: These services have no dependencies, making them ideal for straightforward unit testing. They establish the testing patterns for the project.

Output: Two test files covering all public methods with data providers for edge cases
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-backend-tests/11-RESEARCH.md

@backend/src/Service/RecurrenceService.php
@backend/src/Service/DuplicateDetectionService.php
@backend/src/Enum/RecurrenceType.php
@backend/phpunit.dist.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: RecurrenceService unit tests</name>
  <files>backend/tests/Unit/Service/RecurrenceServiceTest.php</files>
  <action>
Create comprehensive unit tests for RecurrenceService covering:

1. Create directory structure: `backend/tests/Unit/Service/`

2. Test matchesPattern() for all 5 recurrence types:
   - DAILY: Always returns true regardless of date
   - WEEKLY: Only matches same day of week as startDate
   - WEEKDAYS: Only matches Monday-Friday (days 1-5)
   - MONTHLY: Only matches same day of month as startDate
   - CUSTOM: Matches days in recurrenceDays array

3. Test CUSTOM edge cases:
   - Empty recurrenceDays array returns false
   - null recurrenceDays returns false
   - Valid days in array return true

4. Test findNextOccurrenceDate():
   - Returns tomorrow for DAILY pattern
   - Respects endDate (returns null if pattern ended)
   - Returns null if no match within maxDaysAhead

Use PHPUnit 11 attributes:
- #[Test] instead of @test
- #[DataProvider('providerName')] instead of @dataProvider
- Static data provider methods

Pattern from research:
```php
use PHPUnit\Framework\TestCase;
use PHPUnit\Framework\Attributes\Test;
use PHPUnit\Framework\Attributes\DataProvider;
```

Create RecurringTask entities directly (not mocks) - they're simple value objects.
  </action>
  <verify>
Run: `docker compose exec php ./vendor/bin/phpunit tests/Unit/Service/RecurrenceServiceTest.php`
All tests pass with no deprecation warnings.
  </verify>
  <done>
RecurrenceService has 100% test coverage: all 5 recurrence types tested with edge cases, findNextOccurrenceDate tested for both success and end-date scenarios.
  </done>
</task>

<task type="auto">
  <name>Task 2: DuplicateDetectionService unit tests</name>
  <files>backend/tests/Unit/Service/DuplicateDetectionServiceTest.php</files>
  <action>
Create unit tests for DuplicateDetectionService covering:

1. Test isTaskDuplicate():
   - Exact match returns true
   - Case-insensitive matching (lowercase/uppercase)
   - Whitespace-normalized matching (leading/trailing spaces)
   - No match returns false
   - Empty existing array returns false

2. Test isEventDuplicate():
   - Same title and overlapping times returns true
   - Same title but non-overlapping times returns false
   - Different title with overlapping times returns false
   - Case-insensitive title matching

3. Test timesOverlap():
   - Overlapping ranges return true
   - Adjacent ranges return false (10:00-11:00 and 11:00-12:00)
   - Null start times return false
   - Null end times use 1-hour default duration

4. Test isContentDuplicate():
   - Exact match returns true
   - Case-insensitive matching
   - Whitespace-normalized matching
   - No match returns false

Use data providers for comprehensive edge case coverage.
Pattern:
```php
#[Test]
#[DataProvider('taskDuplicateProvider')]
public function detectsTaskDuplicates(string $newTitle, array $existing, bool $expected): void
{
    $this->assertSame($expected, $this->service->isTaskDuplicate($newTitle, $existing));
}

public static function taskDuplicateProvider(): iterable
{
    yield 'exact match' => ['Buy milk', ['Buy milk'], true];
    yield 'case insensitive' => ['buy milk', ['Buy Milk'], true];
    // ...
}
```
  </action>
  <verify>
Run: `docker compose exec php ./vendor/bin/phpunit tests/Unit/Service/DuplicateDetectionServiceTest.php`
All tests pass.
  </verify>
  <done>
DuplicateDetectionService has full test coverage: isTaskDuplicate, isEventDuplicate, timesOverlap, and isContentDuplicate all tested with edge cases for normalization and boundary conditions.
  </done>
</task>

</tasks>

<verification>
Run full test suite for this plan:
```bash
docker compose exec php ./vendor/bin/phpunit tests/Unit/Service/
```

Expected: All tests pass, no deprecation warnings (PHPUnit 11 attributes used correctly).
</verification>

<success_criteria>
1. RecurrenceServiceTest.php exists with tests for all 5 recurrence types
2. DuplicateDetectionServiceTest.php exists with tests for all 4 public methods
3. All tests pass when run via PHPUnit
4. No deprecation warnings (using #[Test] and #[DataProvider] attributes)
5. Tests use direct instantiation (no mocking needed for pure logic services)
</success_criteria>

<output>
After completion, create `.planning/phases/11-backend-tests/11-01-SUMMARY.md`
</output>
