---
phase: 11-backend-tests
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - backend/tests/Unit/Service/TaskServiceTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "TaskService.findByIdAndUser returns null for non-existent task"
    - "TaskService.findByIdAndUser returns null for other user's task"
    - "TaskService.findByIdAndUser returns task for valid owner"
    - "TaskService.create creates task with correct title and date"
    - "TaskService.update handles PATCH semantics (array_key_exists)"
    - "TaskService.delete removes task"
    - "Task completion generates next recurring task when applicable"
  artifacts:
    - path: "backend/tests/Unit/Service/TaskServiceTest.php"
      provides: "TaskService unit tests with mocked dependencies"
      min_lines: 200
  key_links:
    - from: "backend/tests/Unit/Service/TaskServiceTest.php"
      to: "backend/src/Service/TaskService.php"
      via: "constructor injection"
      pattern: "new TaskService"
    - from: "backend/tests/Unit/Service/TaskServiceTest.php"
      to: "backend/src/Repository/TaskRepository.php"
      via: "createMock"
      pattern: "createMock\\(TaskRepository::class\\)"
---

<objective>
Create unit tests for TaskService with mocked dependencies

Purpose: Verify TaskService business logic works correctly in isolation from database. Mocking repositories tests the logic without actual database operations.

Output: Comprehensive TaskService test file covering CRUD, completion, and recurring task generation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-backend-tests/11-RESEARCH.md

@backend/src/Service/TaskService.php
@backend/src/Service/RecurrenceService.php
@backend/src/Service/RecurringSyncService.php
@backend/src/Entity/Task.php
@backend/src/Entity/User.php
@backend/src/Entity/DailyNote.php
@backend/src/Repository/TaskRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: TaskService findByIdAndUser and create tests</name>
  <files>backend/tests/Unit/Service/TaskServiceTest.php</files>
  <action>
Create TaskServiceTest with mocked dependencies. Start with findByIdAndUser and create methods.

1. Set up mocked dependencies in setUp():
```php
use PHPUnit\Framework\TestCase;
use PHPUnit\Framework\Attributes\Test;
use App\Service\TaskService;
use Doctrine\ORM\EntityManagerInterface;
use App\Repository\TaskRepository;
use App\Repository\DailyNoteRepository;
use App\Repository\TagRepository;
use App\Service\RecurrenceService;
use App\Service\RecurringSyncService;

class TaskServiceTest extends TestCase
{
    private TaskService $service;
    private EntityManagerInterface $entityManager;
    private TaskRepository $taskRepository;
    private DailyNoteRepository $dailyNoteRepository;
    private TagRepository $tagRepository;
    private RecurrenceService $recurrenceService;
    private RecurringSyncService $recurringSyncService;

    protected function setUp(): void
    {
        $this->entityManager = $this->createMock(EntityManagerInterface::class);
        $this->taskRepository = $this->createMock(TaskRepository::class);
        $this->dailyNoteRepository = $this->createMock(DailyNoteRepository::class);
        $this->tagRepository = $this->createMock(TagRepository::class);
        $this->recurrenceService = $this->createMock(RecurrenceService::class);
        $this->recurringSyncService = $this->createMock(RecurringSyncService::class);

        $this->service = new TaskService(
            $this->entityManager,
            $this->taskRepository,
            $this->dailyNoteRepository,
            $this->tagRepository,
            $this->recurrenceService,
            $this->recurringSyncService
        );
    }
}
```

2. Test findByIdAndUser():
   - Returns null when task not found
   - Returns null when task belongs to different user (check user ID comparison)
   - Returns task when user matches

For user ownership test, create mocks that return specific IDs:
```php
#[Test]
public function findByIdAndUserReturnsNullForOtherUsersTask(): void
{
    $requestingUser = $this->createMock(User::class);
    $requestingUser->method('getId')->willReturn(1);

    $taskOwner = $this->createMock(User::class);
    $taskOwner->method('getId')->willReturn(2);

    $dailyNote = $this->createMock(DailyNote::class);
    $dailyNote->method('getUser')->willReturn($taskOwner);

    $task = $this->createMock(Task::class);
    $task->method('getDailyNote')->willReturn($dailyNote);

    $this->taskRepository->method('find')->willReturn($task);

    $result = $this->service->findByIdAndUser(1, $requestingUser);
    $this->assertNull($result);
}
```

3. Test create():
   - Creates task with correct title
   - Associates with DailyNote (existing or new)
   - Sets category when provided
   - Sets dueDate when provided
   - Calls persist and flush

For create tests, use expects() to verify EntityManager calls:
```php
#[Test]
public function createPersistsAndFlushesTask(): void
{
    $user = $this->createMock(User::class);
    $dailyNote = $this->createMock(DailyNote::class);

    $this->dailyNoteRepository
        ->method('findByUserAndDate')
        ->willReturn($dailyNote);

    $this->entityManager
        ->expects($this->once())
        ->method('persist')
        ->with($this->isInstanceOf(Task::class));

    $this->entityManager
        ->expects($this->once())
        ->method('flush');

    $request = new TaskCreateRequest(title: 'New Task', date: '2026-01-22');
    $task = $this->service->create($user, $request);

    $this->assertSame('New Task', $task->getTitle());
}
```
  </action>
  <verify>
Run: `docker compose exec php ./vendor/bin/phpunit tests/Unit/Service/TaskServiceTest.php --filter="findByIdAndUser|create"`
Tests pass.
  </verify>
  <done>
findByIdAndUser tested for null task, wrong user, and valid user. create tested for task creation with persist/flush verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskService update and completion tests</name>
  <files>backend/tests/Unit/Service/TaskServiceTest.php</files>
  <action>
Add tests for update(), delete(), and completion handling to TaskServiceTest.

1. Test update() with PATCH semantics:
   - Only updates fields present in data array
   - array_key_exists distinguishes null from missing:
```php
#[Test]
public function updateOnlyChangesProvidedFields(): void
{
    $task = new Task();
    $task->setTitle('Original Title');
    $task->setEstimatedMinutes(30);

    // Only provide title, not estimatedMinutes
    $data = ['title' => 'New Title'];
    $result = $this->service->update($task, $data);

    $this->assertSame('New Title', $result->task->getTitle());
    $this->assertSame(30, $result->task->getEstimatedMinutes()); // Unchanged
}

#[Test]
public function updateSetsFieldToNullWhenExplicitlyProvided(): void
{
    $task = new Task();
    $task->setEstimatedMinutes(30);

    $data = ['estimatedMinutes' => null]; // Explicit null
    $result = $this->service->update($task, $data);

    $this->assertNull($result->task->getEstimatedMinutes());
}
```

2. Test completion handling:
   - Sets isCompleted flag
   - Sets completedAt timestamp when completing
   - Clears completedAt when uncompleting
   - Generates next recurring task when completing recurring task

3. Test recurring task generation on completion:
```php
#[Test]
public function completingRecurringTaskGeneratesNextOccurrence(): void
{
    $recurringTask = $this->createMock(RecurringTask::class);
    $nextDate = new \DateTime('+1 day');
    $generatedTask = new Task();

    $task = new Task();
    // Use reflection or real entity to set recurringTask
    $reflection = new \ReflectionClass($task);
    $prop = $reflection->getProperty('recurringTask');
    $prop->setAccessible(true);
    $prop->setValue($task, $recurringTask);

    $this->recurrenceService
        ->expects($this->once())
        ->method('findNextOccurrenceDate')
        ->with($recurringTask)
        ->willReturn($nextDate);

    $this->recurringSyncService
        ->expects($this->once())
        ->method('generateTask')
        ->with($recurringTask, $nextDate)
        ->willReturn($generatedTask);

    $result = $this->service->update($task, ['isCompleted' => true]);

    $this->assertTrue($result->task->isCompleted());
    $this->assertSame($generatedTask, $result->generatedNextTask);
}
```

4. Test delete():
```php
#[Test]
public function deleteRemovesTask(): void
{
    $task = new Task();

    $this->entityManager
        ->expects($this->once())
        ->method('remove')
        ->with($task);

    $this->entityManager
        ->expects($this->once())
        ->method('flush');

    $this->service->delete($task);
}
```

5. Test tag management:
   - assignTags replaces existing tags
   - Only assigns tags belonging to user
   - removeTag removes specific tag
  </action>
  <verify>
Run: `docker compose exec php ./vendor/bin/phpunit tests/Unit/Service/TaskServiceTest.php`
All tests pass.
  </verify>
  <done>
TaskService fully tested: CRUD operations, PATCH semantics with array_key_exists, completion state management, recurring task generation, tag operations.
  </done>
</task>

</tasks>

<verification>
Run full TaskService test suite:
```bash
docker compose exec php ./vendor/bin/phpunit tests/Unit/Service/TaskServiceTest.php --testdox
```

Expected: All tests pass, demonstrating service logic works correctly with mocked dependencies.
</verification>

<success_criteria>
1. TaskServiceTest.php exists with comprehensive test coverage
2. All dependencies properly mocked (EntityManager, repositories, services)
3. findByIdAndUser authorization logic tested
4. create/update/delete operations tested
5. PATCH semantics (array_key_exists) verified
6. Recurring task generation on completion tested
7. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-backend-tests/11-03-SUMMARY.md`
</output>
