---
phase: 11-backend-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/Unit/DTO/Request/TaskCreateRequestTest.php
  - backend/tests/Unit/DTO/Request/TaskUpdateRequestTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "TaskCreateRequest validation rejects empty title"
    - "TaskCreateRequest validation rejects invalid date formats"
    - "TaskCreateRequest validation rejects invalid category values"
    - "TaskUpdateRequest validation rejects title over 500 characters"
    - "TaskUpdateRequest validation rejects invalid time formats"
    - "TaskUpdateRequest validation rejects negative estimatedMinutes"
  artifacts:
    - path: "backend/tests/Unit/DTO/Request/TaskCreateRequestTest.php"
      provides: "TaskCreateRequest validation tests"
      min_lines: 80
    - path: "backend/tests/Unit/DTO/Request/TaskUpdateRequestTest.php"
      provides: "TaskUpdateRequest validation tests"
      min_lines: 100
  key_links:
    - from: "backend/tests/Unit/DTO/Request/TaskCreateRequestTest.php"
      to: "backend/src/DTO/Request/TaskCreateRequest.php"
      via: "Symfony Validator"
      pattern: "validator->validate"
    - from: "backend/tests/Unit/DTO/Request/TaskUpdateRequestTest.php"
      to: "backend/src/DTO/Request/TaskUpdateRequest.php"
      via: "Symfony Validator"
      pattern: "validator->validate"
---

<objective>
Create unit tests for DTO validation (TaskCreateRequest, TaskUpdateRequest)

Purpose: Ensure that invalid API requests are rejected with appropriate validation errors before reaching service layer.

Output: Two test files verifying all validation constraints are enforced correctly
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-backend-tests/11-RESEARCH.md

@backend/src/DTO/Request/TaskCreateRequest.php
@backend/src/DTO/Request/TaskUpdateRequest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: TaskCreateRequest validation tests</name>
  <files>backend/tests/Unit/DTO/Request/TaskCreateRequestTest.php</files>
  <action>
Create unit tests for TaskCreateRequest validation covering:

1. Create directory structure: `backend/tests/Unit/DTO/Request/`

2. Set up standalone Validator in setUp():
```php
use Symfony\Component\Validator\Validation;

protected function setUp(): void
{
    $this->validator = Validation::createValidatorBuilder()
        ->enableAttributeMapping()
        ->getValidator();
}
```

3. Test valid request passes validation:
   - Valid title and date
   - Valid title, date, and optional category
   - Valid title, date, and optional dueDate

4. Test title validation:
   - Empty title fails (NotBlank)
   - Title over 500 chars fails (Length)

5. Test date validation:
   - Empty date fails (NotBlank)
   - Invalid format 'not-a-date' fails
   - Wrong format '22-01-2026' fails (should be YYYY-MM-DD)

6. Test category validation:
   - 'today' passes
   - 'scheduled' passes
   - 'someday' passes
   - 'invalid' fails (Choice constraint)

7. Test dueDate validation:
   - null passes (optional)
   - Valid date 'YYYY-MM-DD' passes
   - Invalid format fails

Use data providers for formats:
```php
#[Test]
#[DataProvider('invalidDateProvider')]
public function rejectsInvalidDateFormats(string $date): void
{
    $request = new TaskCreateRequest(title: 'Test', date: $date);
    $violations = $this->validator->validate($request);

    $this->assertGreaterThan(0, count($violations));
}

public static function invalidDateProvider(): iterable
{
    yield 'wrong format' => ['22-01-2026'];
    yield 'not a date' => ['not-a-date'];
    yield 'empty string' => [''];
}
```
  </action>
  <verify>
Run: `docker compose exec php ./vendor/bin/phpunit tests/Unit/DTO/Request/TaskCreateRequestTest.php`
All tests pass.
  </verify>
  <done>
TaskCreateRequest validation fully tested: NotBlank on title/date, Length on title, Date format validation, Choice constraint on category, optional dueDate validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskUpdateRequest validation tests</name>
  <files>backend/tests/Unit/DTO/Request/TaskUpdateRequestTest.php</files>
  <action>
Create unit tests for TaskUpdateRequest validation covering:

1. Test all-null request is valid (PATCH semantics - no fields required):
```php
$request = new TaskUpdateRequest();
$violations = $this->validator->validate($request);
$this->assertCount(0, $violations);
```

2. Test title validation:
   - null passes (optional)
   - Valid string passes
   - String over 500 chars fails

3. Test dueDate validation:
   - null passes
   - Valid 'YYYY-MM-DD' passes
   - Invalid format fails

4. Test reminderTime validation (Regex: HH:MM):
   - null passes
   - '09:00' passes
   - '00:00' passes (midnight)
   - '23:59' passes
   - '9:00' fails (single digit hour)
   - '25:00' fails (invalid hour)
   - '09:60' fails (invalid minute)
   - '9:00 AM' fails (AM/PM format)

5. Test estimatedMinutes validation:
   - null passes
   - 0 passes (PositiveOrZero)
   - Positive integer passes
   - Negative integer fails

6. Test fixedTime validation (same Regex as reminderTime):
   - null passes
   - Valid HH:MM passes
   - Invalid formats fail

7. Test boolean fields (no validation constraints):
   - isCompleted: true/false/null all valid
   - needsFullFocus: true/false/null all valid

Use data providers for time format tests:
```php
#[Test]
#[DataProvider('validTimeProvider')]
public function acceptsValidTimeFormats(string $time): void
{
    $request = new TaskUpdateRequest(reminderTime: $time);
    $violations = $this->validator->validate($request);
    $this->assertCount(0, $violations);
}

public static function validTimeProvider(): iterable
{
    yield 'morning' => ['09:00'];
    yield 'noon' => ['12:00'];
    yield 'evening' => ['18:30'];
    yield 'midnight' => ['00:00'];
    yield 'late night' => ['23:59'];
}

#[Test]
#[DataProvider('invalidTimeProvider')]
public function rejectsInvalidTimeFormats(string $time): void
{
    $request = new TaskUpdateRequest(reminderTime: $time);
    $violations = $this->validator->validate($request);
    $this->assertGreaterThan(0, count($violations));
}

public static function invalidTimeProvider(): iterable
{
    yield 'no colon' => ['0900'];
    yield 'am/pm format' => ['9:00 AM'];
    yield 'single digit hour' => ['9:00'];
    yield 'invalid hour' => ['25:00'];
    yield 'invalid minute' => ['09:60'];
}
```
  </action>
  <verify>
Run: `docker compose exec php ./vendor/bin/phpunit tests/Unit/DTO/Request/TaskUpdateRequestTest.php`
All tests pass.
  </verify>
  <done>
TaskUpdateRequest validation fully tested: all-null valid (PATCH), Length on title, Date format on dueDate, Regex on reminderTime/fixedTime, PositiveOrZero on estimatedMinutes.
  </done>
</task>

</tasks>

<verification>
Run full test suite for this plan:
```bash
docker compose exec php ./vendor/bin/phpunit tests/Unit/DTO/Request/
```

Expected: All tests pass, validation errors have correct property paths.
</verification>

<success_criteria>
1. TaskCreateRequestTest.php validates all constraints: NotBlank, Length, Date, Choice
2. TaskUpdateRequestTest.php validates all constraints: Length, Date, Regex (HH:MM), PositiveOrZero
3. All tests pass
4. Tests use standalone Validator with enableAttributeMapping()
5. PATCH semantics verified (empty TaskUpdateRequest is valid)
</success_criteria>

<output>
After completion, create `.planning/phases/11-backend-tests/11-02-SUMMARY.md`
</output>
