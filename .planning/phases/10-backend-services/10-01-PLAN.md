---
phase: 10-backend-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/Service/RecurrenceService.php
  - backend/src/Service/DuplicateDetectionService.php
  - backend/src/Service/RecurringSyncService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "matchesRecurrencePattern() exists in exactly one place"
    - "RecurringSyncService uses RecurrenceService for pattern matching"
    - "Duplicate detection logic is testable in isolation"
  artifacts:
    - path: "backend/src/Service/RecurrenceService.php"
      provides: "Recurrence pattern matching and next occurrence date finding"
      exports: ["matchesPattern", "findNextOccurrenceDate"]
    - path: "backend/src/Service/DuplicateDetectionService.php"
      provides: "Duplicate detection for tasks, events, journal, notes"
      exports: ["isTaskDuplicate", "isEventDuplicate", "isContentDuplicate", "timesOverlap"]
  key_links:
    - from: "RecurringSyncService.php"
      to: "RecurrenceService.php"
      via: "dependency injection"
      pattern: "RecurrenceService"
---

<objective>
Create pure logic services that consolidate duplicated business logic.

Purpose: Eliminate duplication of matchesRecurrencePattern() (currently in TaskController:305-318 AND RecurringSyncService:85-98) and extract duplicate detection from BrainDumpFacade for testability.

Output: Two pure logic services with no external dependencies, ready for use by TaskService and BrainDumpFacade.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-backend-services/10-RESEARCH.md
@backend/src/Service/RecurringSyncService.php
@backend/src/Controller/TaskController.php
@backend/src/Facade/BrainDumpFacade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecurrenceService</name>
  <files>backend/src/Service/RecurrenceService.php</files>
  <action>
Create RecurrenceService as a pure logic service (no dependencies, no EntityManager).

Consolidate matchesRecurrencePattern() from:
- TaskController lines 305-318
- RecurringSyncService lines 85-98

Include:
1. `matchesPattern(RecurringTask $recurringTask, DateTimeInterface $date): bool`
   - DAILY: always true
   - WEEKLY: dayOfWeek matches startDate dayOfWeek
   - WEEKDAYS: dayOfWeek is 1-5 (Mon-Fri)
   - MONTHLY: dayOfMonth matches startDate dayOfMonth
   - CUSTOM: dayOfWeek in recurrenceDays array

2. `findNextOccurrenceDate(RecurringTask $recurringTask, int $maxDaysAhead = 365): ?DateTimeInterface`
   - Start from tomorrow
   - Check up to maxDaysAhead days
   - Respect endDate if set
   - Return first date that matches pattern, or null

Use `final readonly class` pattern. No dependencies.
  </action>
  <verify>
PHPStan: `docker compose exec php php -d memory_limit=512M vendor/bin/phpstan analyse src/Service/RecurrenceService.php --level=max`
  </verify>
  <done>
RecurrenceService exists with matchesPattern() and findNextOccurrenceDate() methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DuplicateDetectionService</name>
  <files>backend/src/Service/DuplicateDetectionService.php</files>
  <action>
Create DuplicateDetectionService as a pure logic service (no dependencies).

Extract from BrainDumpFacade:
- timesOverlap() method (lines 311-332)
- Duplicate detection patterns (lines 96-166)

Include methods:
1. `isTaskDuplicate(string $newTitle, array $existingTitles): bool`
   - Normalize with mb_strtolower(trim())
   - Return true if normalized title in array

2. `isEventDuplicate(string $newTitle, ?DateTimeInterface $newStart, ?DateTimeInterface $newEnd, array $existingEvents): bool`
   - Each existing event: ['title' => string, 'startTime' => ?DateTimeInterface, 'endTime' => ?DateTimeInterface]
   - Match if same normalized title AND times overlap

3. `timesOverlap(?DateTimeInterface $start1, ?DateTimeInterface $end1, ?DateTimeInterface $start2, ?DateTimeInterface $end2): bool`
   - Return false if either start is null
   - Default end to start + 1 hour if null
   - Convert to minutes, compare ranges

4. `isContentDuplicate(string $newContent, array $existingContents): bool`
   - For journal entries and notes
   - Normalize and check in array

Use `final readonly class` pattern. No dependencies.
  </action>
  <verify>
PHPStan: `docker compose exec php php -d memory_limit=512M vendor/bin/phpstan analyse src/Service/DuplicateDetectionService.php --level=max`
  </verify>
  <done>
DuplicateDetectionService exists with all four detection methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update RecurringSyncService to use RecurrenceService</name>
  <files>backend/src/Service/RecurringSyncService.php</files>
  <action>
Refactor RecurringSyncService to use the new RecurrenceService.

Changes:
1. Add RecurrenceService to constructor dependencies
2. Remove private matchesRecurrencePattern() method (lines 85-98)
3. Remove private matchesCustomPattern() method (lines 104-113)
4. Update shouldGenerateForDate() to call $this->recurrenceService->matchesPattern()

The shouldGenerateForDate() method stays in RecurringSyncService (it has additional logic: date range checks, already-generated checks, incomplete task checks).

After this change:
- RecurringSyncService delegates pattern matching to RecurrenceService
- matchesRecurrencePattern() exists in exactly ONE place (RecurrenceService)
  </action>
  <verify>
PHPStan: `docker compose exec php php -d memory_limit=512M vendor/bin/phpstan analyse src/Service/RecurringSyncService.php --level=max`
Test recurrence: Create a daily recurring task, complete it, verify next task generates.
  </verify>
  <done>
RecurringSyncService uses RecurrenceService, no duplicate matchesRecurrencePattern().
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `docker compose exec php php -d memory_limit=512M vendor/bin/phpstan analyse src/Service/ --level=max` passes
2. grep confirms matchesRecurrencePattern exists only in RecurrenceService:
   `grep -r "matchesRecurrencePattern\|matchesPattern" backend/src/` shows only RecurrenceService
3. Frontend still works (no API changes)
</verification>

<success_criteria>
1. RecurrenceService exists with matchesPattern() and findNextOccurrenceDate()
2. DuplicateDetectionService exists with 4 detection methods
3. RecurringSyncService uses RecurrenceService (no internal pattern matching)
4. PHPStan passes for all Service files
5. matchesRecurrencePattern() exists in exactly one place
</success_criteria>

<output>
After completion, create `.planning/phases/10-backend-services/10-01-SUMMARY.md`
</output>
