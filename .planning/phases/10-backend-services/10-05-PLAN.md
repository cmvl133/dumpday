---
phase: 10-backend-services
plan: 05
type: execute
wave: 3
depends_on: ["10-01"]
files_modified:
  - backend/src/Facade/BrainDumpFacade.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "BrainDumpFacade under 200 lines"
    - "Duplicate detection delegated to DuplicateDetectionService"
    - "No duplicate timesOverlap() method in facade"
  artifacts:
    - path: "backend/src/Facade/BrainDumpFacade.php"
      provides: "Brain dump orchestration with reduced complexity"
      max_lines: 200
  key_links:
    - from: "BrainDumpFacade.php"
      to: "DuplicateDetectionService.php"
      via: "duplicate detection calls"
      pattern: "duplicateDetectionService->"
---

<objective>
Refactor BrainDumpFacade to use DuplicateDetectionService.

Purpose: Extract duplicate detection logic (70+ lines) to reduce BrainDumpFacade from 333 lines to under 200. The facade focuses on orchestration, not detection logic.

Output: BrainDumpFacade under 200 lines, using DuplicateDetectionService for all duplicate checks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-backend-services/10-RESEARCH.md
@.planning/phases/10-backend-services/10-01-SUMMARY.md
@backend/src/Facade/BrainDumpFacade.php
@backend/src/Service/DuplicateDetectionService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor BrainDumpFacade to use DuplicateDetectionService</name>
  <files>backend/src/Facade/BrainDumpFacade.php</files>
  <action>
Refactor BrainDumpFacade to delegate duplicate detection.

Add to constructor:
- DuplicateDetectionService

Refactor saveAnalysis() method (lines 73-172):

For tasks (lines 96-107):
```php
$existingTaskTitles = array_map(
    fn ($t) => mb_strtolower(trim($t->getTitle())),
    $dailyNote->getTasks()->toArray()
);

foreach ($this->taskExtractor->extract($analysisResult, $dailyNote) as $task) {
    if (!$this->duplicateDetectionService->isTaskDuplicate($task->getTitle(), $existingTaskTitles)) {
        $dailyNote->addTask($task);
        $existingTaskTitles[] = mb_strtolower(trim($task->getTitle()));
    }
}
```

For events (lines 109-138):
```php
$existingEvents = array_map(fn ($e) => [
    'title' => $e->getTitle(),
    'startTime' => $e->getStartTime(),
    'endTime' => $e->getEndTime(),
], $dailyNote->getEvents()->toArray());

foreach ($this->eventExtractor->extract($analysisResult, $dailyNote) as $event) {
    if (!$this->duplicateDetectionService->isEventDuplicate(
        $event->getTitle(),
        $event->getStartTime(),
        $event->getEndTime(),
        $existingEvents
    )) {
        $dailyNote->addEvent($event);
        $existingEvents[] = [
            'title' => $event->getTitle(),
            'startTime' => $event->getStartTime(),
            'endTime' => $event->getEndTime(),
        ];
    }
}
```

For journal entries (lines 140-152):
```php
$existingJournalContents = array_map(
    fn ($j) => mb_strtolower(trim($j->getContent())),
    $dailyNote->getJournalEntries()->toArray()
);

foreach ($this->journalExtractor->extract($analysisResult, $dailyNote) as $journalEntry) {
    if (!$this->duplicateDetectionService->isContentDuplicate($journalEntry->getContent(), $existingJournalContents)) {
        $dailyNote->addJournalEntry($journalEntry);
        $existingJournalContents[] = mb_strtolower(trim($journalEntry->getContent()));
    }
}
```

For notes (lines 154-166):
```php
$existingNoteContents = array_map(
    fn ($n) => mb_strtolower(trim($n->getContent())),
    $dailyNote->getNotes()->toArray()
);

foreach ($this->noteExtractor->extract($analysisResult, $dailyNote) as $note) {
    if (!$this->duplicateDetectionService->isContentDuplicate($note->getContent(), $existingNoteContents)) {
        $dailyNote->addNote($note);
        $existingNoteContents[] = mb_strtolower(trim($note->getContent()));
    }
}
```

Remove private method:
- timesOverlap() (lines 311-332) - now in DuplicateDetectionService

Target: Under 200 lines total.
  </action>
  <verify>
Line count: `wc -l backend/src/Facade/BrainDumpFacade.php` should show < 200
PHPStan: `docker compose exec php php -d memory_limit=512M vendor/bin/phpstan analyse src/Facade/BrainDumpFacade.php --level=max`
Grep: `grep -c "timesOverlap" backend/src/Facade/BrainDumpFacade.php` should show 0
  </verify>
  <done>
BrainDumpFacade under 200 lines, uses DuplicateDetectionService, no timesOverlap method.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. BrainDumpFacade: `wc -l` < 200 lines
2. No timesOverlap in facade: `grep -c "private function timesOverlap" backend/src/Facade/BrainDumpFacade.php` shows 0
3. PHPStan passes
4. Manual test: Brain dump with duplicate items - duplicates are filtered
5. Cache clear works: `docker compose exec php bin/console cache:clear`
</verification>

<success_criteria>
1. BrainDumpFacade under 200 lines (from 333)
2. timesOverlap() method removed from facade
3. All duplicate detection uses DuplicateDetectionService
4. Existing behavior preserved (duplicates still filtered)
5. PHPStan passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-backend-services/10-05-SUMMARY.md`
</output>
