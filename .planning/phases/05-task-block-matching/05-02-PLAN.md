---
phase: 05-task-block-matching
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/templates/prompts/brain_dump_analysis_en.twig
  - backend/templates/prompts/brain_dump_analysis_pl.twig
  - backend/src/Service/BrainDumpAnalyzer.php
  - backend/src/Facade/BrainDumpFacade.php
  - backend/src/Service/TaskExtractor.php
autonomous: true

must_haves:
  truths:
    - "AI prompt includes user's time blocks for the day"
    - "AI can suggest a block ID for each task it extracts"
    - "Task response includes suggestedBlockId and suggestedBlockName (nullable)"
    - "Tasks without clear block match have null suggestion"
  artifacts:
    - path: "backend/templates/prompts/brain_dump_analysis_en.twig"
      provides: "Enhanced prompt with time blocks context"
      contains: "TIME BLOCKS"
    - path: "backend/templates/prompts/brain_dump_analysis_pl.twig"
      provides: "Polish version with time blocks context"
      contains: "BLOKI CZASOWE"
    - path: "backend/src/Service/TaskExtractor.php"
      provides: "Passes through suggestedBlockId/suggestedBlockName"
      contains: "suggestedBlockId"
  key_links:
    - from: "backend/src/Facade/BrainDumpFacade.php"
      to: "backend/src/Service/TimeBlockService.php"
      via: "Constructor injection"
      pattern: "getActiveBlocksForDate"
    - from: "backend/src/Service/BrainDumpAnalyzer.php"
      to: "templates/prompts/brain_dump_analysis"
      via: "Twig render with time_blocks param"
      pattern: "time_blocks"
---

<objective>
Enhance AI brain dump analysis to include time block context and suggest block assignments for extracted tasks.

Purpose: AI can use time block information to suggest which block a task belongs to, enabling smarter task-to-block matching at brain dump time.

Output: Modified prompts, analyzer, and task extractor that handle block suggestions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-task-block-matching/05-RESEARCH.md

# Existing patterns
@backend/src/Service/BrainDumpAnalyzer.php
@backend/src/Facade/BrainDumpFacade.php
@backend/src/Service/TaskExtractor.php
@backend/templates/prompts/brain_dump_analysis_en.twig
@backend/templates/prompts/brain_dump_analysis_pl.twig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify BrainDumpFacade and BrainDumpAnalyzer to include time blocks</name>
  <files>
backend/src/Facade/BrainDumpFacade.php
backend/src/Service/BrainDumpAnalyzer.php
  </files>
  <action>
1. BrainDumpFacade.analyze() - add time blocks retrieval:
   - TimeBlockService is already injected (check constructor)
   - Before calling analyzer: `$timeBlocks = $this->timeBlockService->getActiveBlocksForDate($user, $date);`
   - Pass to analyzer: `$this->analyzer->analyze($rawContent, $date, $user->getLanguage(), $timeBlocks)`

2. BrainDumpAnalyzer.analyze() - accept time blocks parameter:
   - Change signature: `public function analyze(string $rawContent, \DateTimeInterface $date, string $language = 'en', array $timeBlocks = []): array`
   - Pass to Twig render: add `'time_blocks' => $timeBlocks` to the template context array

Note: TimeBlockService is already injected in BrainDumpFacade constructor (check existing code).
  </action>
  <verify>`php bin/console lint:container` passes</verify>
  <done>BrainDumpAnalyzer receives and passes time blocks to template</done>
</task>

<task type="auto">
  <name>Task 2: Update brain_dump_analysis prompts with time block context</name>
  <files>
backend/templates/prompts/brain_dump_analysis_en.twig
backend/templates/prompts/brain_dump_analysis_pl.twig
  </files>
  <action>
Add time block context section to both prompts. Insert AFTER the date context, BEFORE the main instructions.

For brain_dump_analysis_en.twig, add:
```twig
USER'S TIME BLOCKS FOR TODAY:
{% if time_blocks|length > 0 %}
{% for block in time_blocks %}
- [ID: {{ block.id }}] {{ block.name }} ({{ block.startTime }} - {{ block.endTime }}): tags [{% for tag in block.tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}]
{% endfor %}
{% else %}
(No time blocks configured)
{% endif %}
```

Modify the task JSON output format in the prompt to include block suggestions:
```json
"tasks": {
  "today": [{"title": "...", "suggestedBlockId": 123, "suggestedBlockName": "Work"}],
  "scheduled": [{"title": "...", "dueDate": "YYYY-MM-DD", "suggestedBlockId": null, "suggestedBlockName": null}],
  "someday": [{"title": "..."}]
}
```

Add BLOCK SUGGESTION RULES section (in English):
```
BLOCK SUGGESTION RULES:
- If a task clearly relates to a time block's purpose (based on block name or associated tags), suggest that block
- Example: "finish report for work" relates to a "Work" block with "work" tag -> suggest that block ID
- If no clear match or if you're unsure, set suggestedBlockId and suggestedBlockName to null
- User will see the suggestion and can accept or reject it
- For "someday" tasks, don't suggest blocks (they're not for today)
```

For brain_dump_analysis_pl.twig, add equivalent:
```twig
BLOKI CZASOWE UZYTKOWNIKA NA DZIS:
{% if time_blocks|length > 0 %}
{% for block in time_blocks %}
- [ID: {{ block.id }}] {{ block.name }} ({{ block.startTime }} - {{ block.endTime }}): tagi [{% for tag in block.tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}]
{% endfor %}
{% else %}
(Brak skonfigurowanych blokow czasowych)
{% endif %}
```

And Polish rules:
```
ZASADY SUGEROWANIA BLOKOW:
- Jesli zadanie wyraznie pasuje do bloku czasowego (na podstawie nazwy lub tagow), zasugeruj ten blok
- Przyklad: "dokonczyc raport do pracy" pasuje do bloku "Praca" z tagiem "praca" -> zasugeruj ten blok
- Jesli nie ma wyraznego dopasowania lub nie jestes pewien, ustaw suggestedBlockId i suggestedBlockName na null
- Uzytkownik zobaczy sugestie i moze ja zaakceptowac lub odrzucic
- Dla zadan "someday" nie sugeruj blokow (nie sa na dzis)
```
  </action>
  <verify>Check prompts render correctly: `cat backend/templates/prompts/brain_dump_analysis_en.twig | head -60`</verify>
  <done>Both prompts include time block context and block suggestion rules</done>
</task>

<task type="auto">
  <name>Task 3: Update TaskExtractor to pass through block suggestions</name>
  <files>backend/src/Service/TaskExtractor.php</files>
  <action>
TaskExtractor creates Task entities from AI response. Block suggestions should be passed through to the frontend but NOT stored in the Task entity (per research: don't modify Task entity).

Return suggestedBlockId and suggestedBlockName in the serialized response instead:

1. The extract() method returns Task[] - this is correct, Task entity doesn't store block suggestions
2. The block suggestion should flow through the response chain: AI -> BrainDumpFacade -> Controller -> Frontend

However, looking at the code flow:
- BrainDumpFacade.analyze() returns the raw AI response
- BrainDumpFacade.saveAnalysis() uses TaskExtractor to create Task entities
- The frontend receives the analyze() preview first, then calls save

So the block suggestion should be passed through in the analyze() response to frontend, not stored.

Modify TaskExtractor to ALSO return the suggestion data alongside tasks. Change approach:

Actually, simpler: the AI response with suggestedBlockId goes directly to frontend from analyze(). The TaskExtractor doesn't need changes - it creates entities, not the preview response.

BUT: We need to ensure the analyze() response includes block suggestions. Check BrainDumpFacade.analyze():
- It returns `$aiResponse['tasks']` directly
- So AI response with suggestedBlockId/suggestedBlockName will flow through

No changes needed to TaskExtractor - the suggestion is part of AI response, not stored.

However, for consistency and to prevent confusion, let's document this in TaskExtractor:
- Add a comment explaining that suggestedBlockId/suggestedBlockName are in AI response but not stored in Task entity
- The match is computed dynamically from tags, not persisted

Actually, let me verify the flow works:
1. AI returns: `{"tasks": {"today": [{"title": "x", "suggestedBlockId": 1, "suggestedBlockName": "Work"}]}}`
2. BrainDumpFacade.analyze() returns this in `'tasks' => $aiResponse['tasks']`
3. Frontend receives it and can show the suggestion

This works without TaskExtractor changes. But for safety, add a docblock note.
  </action>
  <verify>Verify flow: analyze endpoint returns AI response with suggestedBlockId when testing manually (requires OpenAI call)</verify>
  <done>Block suggestions flow from AI response to frontend without being stored in Task entity</done>
</task>

</tasks>

<verification>
1. `php bin/console lint:container` - no errors
2. Brain dump prompts include time block context section
3. AI response format documented to include suggestedBlockId/suggestedBlockName
4. Suggestion data flows through analyze() to frontend (not stored in DB)
</verification>

<success_criteria>
- Brain dump prompts include time blocks for the day
- AI can see block names, times, and associated tags
- AI response includes suggestedBlockId and suggestedBlockName for today's tasks
- Suggestions flow through to frontend in analyze preview
- Task entity NOT modified (suggestions are computed, not stored)
</success_criteria>

<output>
After completion, create `.planning/phases/05-task-block-matching/05-02-SUMMARY.md`
</output>
