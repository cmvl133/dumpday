---
phase: 06
plan: 02
title: Fix Note Creation and HTML Rendering Bugs + UX Improvements
type: execute
wave: 1
depends_on: ["06-01"]
files_modified:
  - backend/src/Controller/NoteController.php
  - frontend/package.json
  - frontend/tailwind.config.js
  - frontend/src/components/analysis/NotesList.tsx
  - frontend/src/i18n/locales/en.json
  - frontend/src/i18n/locales/pl.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User clicks 'Add new note' in expanded panel and note is created successfully (no API error)"
    - "HTML content in NotesList preview renders correctly (bold, lists, headings visible)"
    - "Main screen Notes section has 'Add quick note' for inline and 'Add Note' for expanded panel"
    - "Clicking edit on existing note opens the expanded panel for editing"
  artifacts:
    - path: "backend/src/Controller/NoteController.php"
      provides: "Backend accepts empty content for new notes"
    - path: "frontend/tailwind.config.js"
      provides: "Typography plugin enabled for prose classes"
    - path: "frontend/src/components/analysis/NotesList.tsx"
      provides: "Dual button UX and redirect to expanded panel for edit"
  key_links:
    - from: "NotesList.tsx"
      to: "NotesExpandedModal"
      via: "setIsExpanded(true) with selectedNoteId"
      pattern: "setIsExpanded.*true"
    - from: "tailwind.config.js"
      to: "prose classes"
      via: "typography plugin"
      pattern: "@tailwindcss/typography"
---

<objective>
Fix remaining bugs found in manual testing of Phase 6 and implement UX improvements for the Notes section.

Purpose: Complete notes functionality with working API, proper HTML rendering, and improved UX on main screen.

Output: All bugs fixed + improved main screen notes UX with dual add buttons and expanded panel for editing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-notes-panel-fixes/06-01-SUMMARY.md

# Source files to modify
@backend/src/Controller/NoteController.php
@frontend/src/components/analysis/NotesList.tsx
@frontend/package.json
@frontend/tailwind.config.js
@frontend/src/i18n/locales/en.json
@frontend/src/i18n/locales/pl.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix backend to accept empty content for new notes</name>
  <files>backend/src/Controller/NoteController.php</files>
  <action>
The issue: `NotesExpandedModal.tsx` calls `onAdd('')` which results in `createNote({ content: '', date })`. The backend (line 53) validates `empty($data['content'])` and rejects empty content with error "Content and date are required".

For new note creation in the expanded panel, empty content is expected - the user will fill in content in the WYSIWYG editor after creation.

Implementation:

1. In NoteController.php, modify the create method validation (lines 53-57):

   Change from:
   ```php
   if (empty($data['content']) || empty($data['date'])) {
       return $this->json([
           'error' => 'Content and date are required',
       ], Response::HTTP_BAD_REQUEST);
   }
   ```

   To:
   ```php
   if (!isset($data['content']) || empty($data['date'])) {
       return $this->json([
           'error' => 'Date is required',
       ], Response::HTTP_BAD_REQUEST);
   }
   ```

   This allows content to be empty string but still requires date. The `isset()` check ensures content key exists, but allows empty value.

2. Update line 70 to handle empty content gracefully:
   ```php
   $note->setContent($data['content'] ?? '');
   ```

This is safe because:
- Content is always a string (empty or not)
- The WYSIWYG editor will allow user to fill in content after creation
- The note can be deleted if abandoned
  </action>
  <verify>
Test via curl or browser network tab:
```bash
curl -X POST http://localhost:8080/api/note \
  -H "Content-Type: application/json" \
  -d '{"content": "", "date": "2026-01-22"}' \
  --cookie "BEARER=<your-token>"
```
Expected: 201 Created with note object (not 400 error)
  </verify>
  <done>Backend accepts empty content for note creation, returns 201</done>
</task>

<task type="auto">
  <name>Task 2: Install @tailwindcss/typography and enable prose classes</name>
  <files>
    frontend/package.json
    frontend/tailwind.config.js
  </files>
  <action>
The issue: NotesList.tsx uses `prose prose-sm dark:prose-invert` classes but the @tailwindcss/typography plugin is not installed. Without it, prose classes have no effect - only browser defaults apply (so `<b>` works but lists/headings don't render correctly).

Implementation:

1. Install the typography plugin:
   ```bash
   cd /home/kamil/Code/dumpday/frontend && npm install -D @tailwindcss/typography
   ```

2. Update tailwind.config.js to add the plugin:

   Change line 64:
   ```javascript
   plugins: [require('tailwindcss-animate')],
   ```

   To:
   ```javascript
   plugins: [
     require('tailwindcss-animate'),
     require('@tailwindcss/typography'),
   ],
   ```

After this, the prose classes in NotesList.tsx (line 150) and TiptapEditor.tsx (lines 70-76) will properly style HTML content.
  </action>
  <verify>
1. Rebuild frontend: `cd frontend && npm run dev`
2. Create a note with formatting (bold, list, heading)
3. View in NotesList preview
4. Verify lists show bullets, headings are larger, bold is bold
5. Check browser console for no Tailwind warnings
  </verify>
  <done>Typography plugin installed and prose classes render correctly</done>
</task>

<task type="auto">
  <name>Task 3: Redesign NotesList UX with dual add buttons and expanded edit</name>
  <files>
    frontend/src/components/analysis/NotesList.tsx
    frontend/src/i18n/locales/en.json
    frontend/src/i18n/locales/pl.json
  </files>
  <action>
Implement UX improvements for the main screen Notes section:
a) "Add quick note" - keeps current inline behavior (simple text)
b) "Add Note" - opens expanded panel and creates new note there
c) Clicking edit on existing note - opens expanded panel instead of inline editing

Implementation in NotesList.tsx:

1. Add state for passing selected note to expanded modal (after line 34):
   ```typescript
   const [expandWithNewNote, setExpandWithNewNote] = useState(false);
   ```

2. Add handler for opening expanded panel with new note (after handleKeyDown):
   ```typescript
   const handleAddInExpanded = () => {
     setExpandWithNewNote(true);
     setIsExpanded(true);
   };
   ```

3. Add handler for editing in expanded panel (after handleAddInExpanded):
   ```typescript
   const handleEditInExpanded = (note: Note) => {
     setIsExpanded(true);
   };
   ```

4. Replace the edit button onClick (line 161):
   Change from:
   ```tsx
   onClick={() => handleEdit(note as Note)}
   ```
   To:
   ```tsx
   onClick={() => handleEditInExpanded(note as Note)}
   ```

5. Update the buttons section (lines 201-225) to have two add buttons:
   Replace:
   ```tsx
   {/* Add note and expand buttons */}
   {!isPreview && (
     <div className="flex gap-2 mt-2">
       {onAdd && !isAdding && (
         <Button
           variant="ghost"
           size="sm"
           className="flex-1 text-muted-foreground hover:text-foreground"
           onClick={handleStartAdding}
         >
           <Plus className="h-4 w-4 mr-1" />
           {t('tasks.addNote')}
         </Button>
       )}
       <Button
         variant="ghost"
         size="sm"
         className="text-muted-foreground hover:text-foreground"
         onClick={() => setIsExpanded(true)}
         title={t('notes.expand')}
       >
         <Maximize2 className="h-4 w-4" />
       </Button>
     </div>
   )}
   ```

   With:
   ```tsx
   {/* Add note buttons and expand */}
   {!isPreview && (
     <div className="flex gap-2 mt-2">
       {onAdd && !isAdding && (
         <>
           <Button
             variant="ghost"
             size="sm"
             className="text-muted-foreground hover:text-foreground"
             onClick={handleStartAdding}
           >
             <Plus className="h-4 w-4 mr-1" />
             {t('notes.addQuickNote')}
           </Button>
           <Button
             variant="ghost"
             size="sm"
             className="flex-1 text-muted-foreground hover:text-foreground"
             onClick={handleAddInExpanded}
           >
             <Plus className="h-4 w-4 mr-1" />
             {t('tasks.addNote')}
           </Button>
         </>
       )}
       <Button
         variant="ghost"
         size="sm"
         className="text-muted-foreground hover:text-foreground"
         onClick={() => setIsExpanded(true)}
         title={t('notes.expand')}
       >
         <Maximize2 className="h-4 w-4" />
       </Button>
     </div>
   )}
   ```

6. Modify NotesExpandedModal props to trigger new note on open (lines 228-236):
   ```tsx
   <NotesExpandedModal
     isOpen={isExpanded}
     onClose={() => {
       setIsExpanded(false);
       setExpandWithNewNote(false);
     }}
     notes={notes.filter((n): n is Note => 'id' in n)}
     currentDate={currentDate}
     onUpdate={onUpdate}
     onDelete={onDelete}
     onAdd={onAdd}
     triggerNewNote={expandWithNewNote}
   />
   ```

7. Add i18n translations:

In en.json, add under "notes" section (or create if doesn't exist):
```json
"notes": {
  ...existing...
  "addQuickNote": "Quick note"
}
```

In pl.json, add:
```json
"notes": {
  ...existing...
  "addQuickNote": "Szybka notatka"
}
```

Note: The `triggerNewNote` prop needs to be added to NotesExpandedModal.tsx to handle auto-creation on open. However, the current implementation with `onAdd('')` will now work since Task 1 fixed the backend.
  </action>
  <verify>
1. Open the app, go to Notes section on main screen
2. Verify two buttons: "Quick note" and "Add Note"
3. Click "Quick note" - verify inline textarea appears
4. Click "Add Note" - verify expanded modal opens
5. Click edit (pencil) on existing note - verify expanded modal opens
6. Create a note in expanded panel - verify it saves and appears in list
  </verify>
  <done>Main screen Notes has dual add buttons and edit redirects to expanded panel</done>
</task>

</tasks>

<verification>
After all tasks:

1. Backend accepts empty content: POST /api/note with `{"content": "", "date": "..."}` returns 201
2. HTML preview works: Notes with formatting show correctly in NotesList (bold, lists, headings)
3. Dual buttons: Main screen has "Quick note" (inline) and "Add Note" (expanded)
4. Edit redirects: Clicking edit pencil opens expanded panel, not inline textarea

Run `cd frontend && npm run lint` to check for errors.
Run `cd backend && composer run phpstan` to check for PHP errors.
</verification>

<success_criteria>
- "Add new note" from expanded panel creates note without API error
- HTML content renders correctly in NotesList preview (prose classes work)
- Main screen has intuitive dual-button UX for notes
- All editing happens in expanded panel with WYSIWYG
- No lint/type errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-notes-panel-fixes/06-02-SUMMARY.md`
</output>
