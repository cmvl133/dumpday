---
phase: 06
plan: 01
title: Fix Notes Panel Bugs
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/ui/dialog.tsx
  - frontend/src/components/notes/NotesExpandedModal.tsx
  - frontend/src/components/analysis/NotesList.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks 'Add new note' in modal and a new empty note is created and selected for editing"
    - "Notes panel has exactly one close button (top right)"
    - "WYSIWYG editor shows formatted text while editing"
    - "Note preview in NotesList displays rendered HTML content"
  artifacts:
    - path: "frontend/src/components/ui/dialog.tsx"
      provides: "DialogContent with hideCloseButton prop"
    - path: "frontend/src/components/notes/NotesExpandedModal.tsx"
      provides: "Fixed add note flow and uses DialogContent with hideCloseButton"
    - path: "frontend/src/components/analysis/NotesList.tsx"
      provides: "HTML rendering for note preview"
  key_links:
    - from: "NotesExpandedModal.tsx"
      to: "DialogContent"
      via: "hideCloseButton prop"
      pattern: "DialogContent.*hideCloseButton"
---

<objective>
Fix all four bugs in the Notes panel functionality.

Purpose: Users need working notes management with proper WYSIWYG editing and clean UI.

Output: All NOTE-01 through NOTE-04 requirements satisfied.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@frontend/src/components/notes/NotesExpandedModal.tsx
@frontend/src/components/notes/TiptapEditor.tsx
@frontend/src/components/analysis/NotesList.tsx
@frontend/src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix duplicate close button (NOTE-02)</name>
  <files>
    frontend/src/components/ui/dialog.tsx
    frontend/src/components/notes/NotesExpandedModal.tsx
  </files>
  <action>
The DialogContent component in dialog.tsx (lines 45-48) automatically renders a close button. NotesExpandedModal.tsx (lines 257-259) also renders its own close button, causing duplicates.

Implementation:

1. In dialog.tsx, modify DialogContent (lines 30-52) to accept `hideCloseButton` prop:
   - Add to the type: `React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content> & { hideCloseButton?: boolean }`
   - Destructure `hideCloseButton` from props on line 33
   - Wrap the DialogPrimitive.Close (lines 45-48) with `{!hideCloseButton && (...)}`

2. In NotesExpandedModal.tsx line 160, add `hideCloseButton` prop:
   Change: `<DialogContent className="max-w-5xl h-[80vh] p-0 gap-0">`
   To: `<DialogContent className="max-w-5xl h-[80vh] p-0 gap-0" hideCloseButton>`
  </action>
  <verify>
    - Open the app and expand the Notes panel
    - Verify there is exactly ONE close button in the top right of the header
    - Click it and verify the modal closes
  </verify>
  <done>Notes expanded modal has single close button in custom header position</done>
</task>

<task type="auto">
  <name>Task 2: Fix "Add new note" button (NOTE-01)</name>
  <files>frontend/src/components/notes/NotesExpandedModal.tsx</files>
  <action>
The current `handleAddNote` function (lines 133-139) creates a note but doesn't auto-select it for editing.

Implementation:

1. Add state to track pending new note (after line 40):
   ```typescript
   const [pendingNewNote, setPendingNewNote] = useState(false);
   ```

2. Replace handleAddNote function (lines 133-139) with:
   ```typescript
   const handleAddNote = () => {
     if (onAdd) {
       setPendingNewNote(true);
       onAdd('');
       setTimeout(loadNotes, 150);
     }
   };
   ```

3. In loadNotes function, after `setNotes(result);` on line 61, add auto-selection logic:
   ```typescript
   setNotes(result);

   // Auto-select newest note if we just added one
   if (pendingNewNote && result.length > 0 && sortOrder === 'newest') {
     setSelectedNote(result[0]);
     setEditContent(result[0].content);
     setPendingNewNote(false);
   } else if (selectedNote) {
     // existing code for keeping selection...
   }
   ```

   The full loadNotes function should become:
   ```typescript
   const loadNotes = async () => {
     try {
       const result = await api.note.list(sortOrder);
       setNotes(result);

       // Auto-select newest note if we just added one
       if (pendingNewNote && result.length > 0 && sortOrder === 'newest') {
         setSelectedNote(result[0]);
         setEditContent(result[0].content);
         setPendingNewNote(false);
       } else if (selectedNote) {
         // If we had a selected note, try to keep it selected
         const stillExists = result.find((n) => n.id === selectedNote.id);
         if (stillExists) {
           setSelectedNote(stillExists);
           setEditContent(stillExists.content);
         }
       }
     } catch {
       // Use initial notes as fallback
       setNotes(initialNotes);
     }
   };
   ```
  </action>
  <verify>
    - Open Notes expanded modal
    - Click "Add new note" button
    - Verify a new empty note appears in the sidebar list
    - Verify the new note is automatically selected
    - Verify the TiptapEditor is ready to accept input
    - Type some text and click away - verify text is saved
  </verify>
  <done>Add new note creates a note and auto-selects it for immediate editing</done>
</task>

<task type="auto">
  <name>Task 3: Verify WYSIWYG editor display (NOTE-03)</name>
  <files>frontend/src/components/notes/TiptapEditor.tsx</files>
  <action>
Verify that TiptapEditor correctly displays formatted content in edit mode.

The TiptapEditor component (lines 43-80) is configured with:
- StarterKit for basic formatting (bold, italic, headings, lists)
- Placeholder extension
- Link extension
- Prose classes for styling (lines 70-75)
- Content syncs via useEffect (lines 83-87)

This task is verification-only. The editor should already work correctly.

Test steps:
1. Open Notes expanded modal
2. Select an existing note with formatted content, OR:
3. Create a new note and add formatting:
   - Type text and make some bold (Ctrl+B)
   - Add a heading (click H1 button)
   - Add a bulleted list
4. Verify formatting appears correctly while editing (not raw HTML)
5. Click away to save, then click back on the note
6. Verify formatting is preserved and displayed correctly

If verification fails, investigate TiptapEditor content prop handling and editor.commands.setContent behavior.
  </action>
  <verify>
    - Bold text appears bold (not as `<strong>text</strong>`)
    - Headings appear larger
    - Lists show bullets/numbers
    - Formatting toolbar buttons reflect current format state
  </verify>
  <done>WYSIWYG editor displays formatted content correctly in edit mode</done>
</task>

<task type="auto">
  <name>Task 4: Fix HTML preview in NotesList (NOTE-04)</name>
  <files>frontend/src/components/analysis/NotesList.tsx</files>
  <action>
In NotesList.tsx, find the note content display element (likely a `<p>` tag showing `note.content`).

Note content contains HTML from Tiptap editor but is rendered as plain text.

Implementation:

1. Locate the element rendering `note.content` in the note preview
2. Replace plain text rendering:
   ```tsx
   <p className="...">{note.content}</p>
   ```

   With dangerouslySetInnerHTML:
   ```tsx
   <div
     className="text-sm flex-1 prose prose-sm dark:prose-invert max-w-none line-clamp-2"
     dangerouslySetInnerHTML={{ __html: note.content }}
   />
   ```

The prose classes from Tailwind Typography will style the HTML content. The line-clamp-2 limits preview length.

Note: @tailwindcss/typography should already be installed based on TiptapEditor using prose classes.
  </action>
  <verify>
    - Create a note with formatting (bold text, a list, a heading)
    - Close the expanded modal
    - View the note in the main NotesList section
    - Verify the preview shows formatted content (bold is bold, list has bullets)
    - NOT raw HTML tags like `<strong>`, `<ul>`, etc.
  </verify>
  <done>NotesList renders HTML content with proper formatting</done>
</task>

</tasks>

<verification>
After all tasks:

1. NOTE-01: Click "Add new note" in expanded modal -> note created and selected for editing
2. NOTE-02: Expanded modal has exactly one close button
3. NOTE-03: TiptapEditor in expanded modal shows formatted text correctly
4. NOTE-04: NotesList preview shows rendered HTML, not raw tags

Run `npm run lint` in frontend to check for errors.
</verification>

<success_criteria>
- All four NOTE requirements pass manual verification
- No duplicate UI elements
- No TypeScript/lint errors
- Notes workflow is smooth: create -> edit -> save -> preview shows formatted content
</success_criteria>

<output>
After completion, create `.planning/phases/06-notes-panel-fixes/06-01-SUMMARY.md`
</output>
